---
title: "日付計算を要するアレコレ"
author: "@anemptyarchive\\thanks{\\url{https://www.anarchive-beta.com/}}"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  html_document:
    toc: TRUE       # 目次
    toc_depth: 3    # 目次の見出しレベル
    toc_float: TRUE # 目次のスクロール追跡
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

----

【編集履歴】

- 2023.05.27：「カレンダーを作成したい」を追加
- 2023.06.11：「経過日数を求めたい」を追加

----

\ 


# ggplot2でカレンダーを作成したい

　ggplot2パッケージを利用してカレンダーを作成する。\
\

　利用するパッケージを読み込む。

```{r, eval=FALSE}
# 利用パッケージ
library(tidyverse)
library(lubridate)
library(zipangu)
```

```{r, echo=FALSE}
### 資料作成用

# チェック用
library(ggplot2)
```

　この記事では基本的に、`パッケージ名::関数名()`の記法を使うので、パッケージを読み込む必要はない。ただし、作図コードについてはパッケージ名を省略するため、`ggplot2`を読み込む必要がある。\
　また、`magrittr`パッケージのパイプ演算子`%>%`ではなく、ネイティブパイプ演算子`|>`を使う。`%>%`に置き換えても処理できるが、その場合は`magrittr`を読み込む必要がある。\
\


## インデックスの確認

　まずは、カレンダーの作図に用いるインデックス(日ごとのセル(マス)のプロット位置)を確認する。\
\

　行と列のインデックスを作成する。

```{r}
# インデックスを作成
index_df <- tibble::tibble(
  week_idx = rep(1:6, each = 7),  # 行インデックス
  dow_idx  = rep(1:7, times = 6), # 列インデックス
  cell_idx = 1:(7*6) # セルインデックス
)
index_df
```

　行インデックス(縦方向のプロット位置)として、第6週までを表す`1`から`6`の整数を作成して、`week_idx`列とする。\
　列インデックス(横方向のプロット位置)として、曜日を表す`1`から`7`の整数を作成して、`dow_idx`列とする。\
　セルインデックスとして、`1`から`7 * 6`の整数を作成して、`cell_idx`列とする。\

　グラフでインデックスを確認する。

```{r, fig.width=7, fig.height=6, dpi=100}
# インデックスを作図
ggplot() + 
  geom_tile(data = index_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            color = "black", alpha = 0) + # セル
  geom_text(data = index_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = cell_idx), 
            size = 5) + # セルインデックスラベル
  scale_x_continuous(breaks = 1:max(index_df[["dow_idx"]])) + # 行インデックス
  scale_y_reverse(breaks = 1:max(index_df[["week_idx"]])) + # 列インデックス
  coord_fixed(ratio = 1) + # アスペクト比
  theme(panel.grid.minor = element_blank()) + # 図の体裁
  labs(title = "セルインデックス (cell_idx)", 
       x = "曜日インデックス (dow_idx)", 
       y = "週インデックス (week_idx)")
```

　6×7個の日付セルでカレンダーを表現できる。各セルの交点は、曜日番号±0.5、週番号±0.5である。\
　交点を作らない(セル間を空ける)場合は、`geom_tile()`の`width`引数で横サイズ、`height`引数で縦サイズを調整できる。\

　セルインデックスは、横縦の順に割り当てておき、行インデックス(第何週か)の計算に用いる。\
\


## ひと月のカレンダー

　1か月のカレンダーを作成する。\
\


### 基本形

　作成するカレンダーの年・月と、週の始まりの曜日を指定する。

```{r}
# 年を指定
year <- 2024

# 月を指定
month <- 2

# 週初めの曜日を指定:(月: 1, ..., 日: 7)
dow_start_idx <- 1

# 土曜・日曜の曜日インデックスを設定
dow_sat_idx <- ifelse(dow_start_idx == 7, yes = 7, no = 7 - dow_start_idx)
dow_sun_idx <- 8 - dow_start_idx
dow_sat_idx; dow_sun_idx
```

　年を`year`、月を`month`として整数を指定する。\

　週始めの曜日を`dow_start_idx`として`1`から`7`の整数で指定する。`wday()`の`week_start`引数に指定する値で、`1`なら月曜、`2`なら火曜・・・が週始めになる。デフォルトは`7`で日曜始まりである。\
　週始めの曜日を`1`として曜日番号(インデックス)が割り当てられる。土曜日と日曜日に関して、番号を計算してそれぞれ`dow_***_idx`としておく。\

　日付データを作成する。

```{r}
# ひと月の暦データを作成
date_df <- tibble::tibble(
  # 1日間隔の日付を作成
  date = seq(
    from = paste0(year, "-", month, "-01") |> 
      lubridate::as_date(), # 初日
    to   = paste0(year, "-", month, "-01") |> 
      lubridate::as_date() |> 
      lubridate::rollforward(), # 末日
    by = "day"
  ), 
) |> 
  dplyr::mutate(
    day = lubridate::day(date), # 日にちラベル
    # 作図用の値を作成
    dow_idx   = lubridate::wday(date, week_start = dow_start_idx), # 曜日番号(列インデックス)
    dow_label = lubridate::wday(date, week_start = dow_start_idx, label = TRUE), # 曜日ラベル
    cell_idx  = day + head(dow_idx, n = 1) - 1, # セルインデックス
    week_idx  = (cell_idx - 1) %/% 7 + 1 # 週番号(行インデックス)
  )
date_df
```

　指定した月の初日から最終日までの日付を`seq(by = "day")`で作成して、データフレームに格納する。月初の日付を表す文字列`yyyy-mm-01`を作成して、`as_date()`で日付型に変換して用いる。さらに、`rollforward()`で月末の日付が得られる。\
　日付ごとに、`day()`で日にち列、`wday()`で曜日番号列を作成する。また確認用に、`wday()`の`label`引数を`TRUE`にして、曜日ラベル列を作成する。\
　「月初の曜日番号-1」に各日付の「日にち」を加えるとセル番号が得られる。\
　「セル番号-1」を「7で割った余り」に「1」を加えると週番号が得られる。商余は`%/%`で計算できる。\

　1か月分のカレンダーの原型を作成する。

```{r, fig.width=7, fig.height=6, dpi=100}
# 横軸ラベルを作成
dow_label_vec <- lubridate::wday(1:7, week_start = dow_start_idx, label = TRUE) |> # 日本語名
  sort()
#dow_label_vec <- lubridate::wday(1:7, week_start = dow_start_idx, label = TRUE, abbr = TRUE, locale = "en_US") |> # 英語名の省略形
#  sort()

# ひと月のカレンダーを作図:(原型)
ggplot() + 
  geom_tile(data = date_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            fill = "white", color = "black") + # 日付セル
  geom_text(data = date_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = day), 
            size = 10) + # 日付ラベル
  scale_x_continuous(breaks = 1:7, labels = dow_label_vec) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  coord_fixed(ratio = 1) + # アスペクト比
  theme(panel.grid.minor = element_blank()) + # 図の体裁
  labs(title = paste0(year, "年", month, "月のカレンダー"), 
       x = "曜日", y = "週")
```

　日ごとのセルを`geom_tile()`、日付ラベルなどを`geom_text()`で描画する。\
　`scale_x_continuous()`で横軸ラベルに曜日を表示して、`scale_y_reverse()`で縦軸を昇順にする。\
　`wday()`の`label = TRUE`に加えて、`abbr`引数で曜日名の省略形、`locale`引数で曜日名の言語を指定できる。\

　月曜始まりのカレンダーで月初の曜日が木曜日(曜日番号が`4`)の場合は、各日にちに`3`を足した値がセルインデックス(各セルインデックスを`3`移動すると日にち)に対応するのが分かる。\
\

　続いて、祝日とカレンダーの体裁を設定する。\
\


### 装飾

　祝日データを取得する。

```{r}
# 祝日情報を取得
holiday_vec <- zipangu::jholiday(year = year, lang = "jp") |> 
  unlist() |> 
  lubridate::as_date()
holiday_vec
```

　`zipangu`パッケージの`jholiday()`を使って日本の祝日情報を取得する。各祝日の日付がリストで出力されるので、`unlist()`でベクトルに変換する。その際に、日付がシリアル値になるので、`as_date()`で日付型に変換する。要素名が祝日名になる。要素名は`names()`で取り出せる。\
　`lang`引数に`"en"`を指定すると、英語の祝日名(`*** Day`)が出力される。が、文字数が増えて処理が面倒なのでここでは省略する。半角スペースを改行に置き換えるといい感じになる気がする。\

　祝日データを格納する。

```{r}
# 祝日の暦データを作成
tmp_holiday_df <- tibble::tibble(
  date = holiday_vec, # 祝日の日付
  holiday_label = names(holiday_vec), # 祝日ラベル
  dow_idx = lubridate::wday(date, week_start = dow_start_idx) # 振替休日の作成用
) |> 
  dplyr::filter(lubridate::month(date) == month) # 指定した月の祝日を抽出
tmp_holiday_df
```

　各祝日の日付と名前をデータフレームに格納して、指定した月のデータのみを取り出す。\
　振替休日の作成に用いる曜日番号も格納しておく。\

　祝日データに振替休日データを追加する。

```{r}
# 振替休日の暦データを作成
holiday_df <- tmp_holiday_df |> 
  dplyr::filter(dow_idx == dow_sun_idx) |> # 日曜日の祝日を抽出
  dplyr::mutate(
    date = dplyr::case_when(
      holiday_label == "憲法記念日" ~ date + lubridate::days(3), 
      holiday_label == "みどりの日" ~ date + lubridate::days(2), 
      TRUE ~ date + lubridate::days(1)
    ), # 日にち
    holiday_label = "振替休日", # 祝日名
    dow_idx = lubridate::wday(date, week_start = dow_start_idx) # 祝日データの結合用
  ) |> 
  dplyr::bind_rows(tmp_holiday_df) |> # 祝日の暦データを結合
  dplyr::select(date, holiday_label, holiday_label) |> # 日付データの結合用
  dplyr::arrange(date)
holiday_df
```

　祝日データから、祝日が日曜日の場合は取り出して、翌日の値に書き換える。ただし、憲法記念日とみどりの日の場合は、翌日も休日であるため、それぞれ3日後と2日後の値に書き換える。(翌月の日付になる場合は取り除く必要があるが、日本の場合は無いので省略。)\
　祝日データを`bind_rows()`で結合して、日付データと重複する(`date`列以外の)列を取り除く。\

　日付データに休日データを追加する。

```{r}
# 装飾用の暦データを作成
calendar_df <- date_df |> 
  dplyr::left_join(holiday_df, by = "date") |> # 祝日データを結合
  dplyr::mutate(
    date_type = dplyr::case_when(
      !is.na(holiday_label) ~ "holiday", 
      dow_idx == dow_sun_idx ~ "holiday", 
      dow_idx == dow_sat_idx ~ "weekend", 
      TRUE ~ "weekday"
    ) # 日付カテゴリ
  )
calendar_df
```

　日付データに祝日データを`left_join()`で結合する。\
　作図時の色付け設定用に、日付カテゴリ列を作成する。この例では、平日・日曜日と祝日・(祝日以外の)土曜日の3つに分類する値を設定する。分類用の値は文字列でなくとも何でもよい。\

　セルを塗りつぶして休日を示すカレンダーを作成する。

```{r, fig.width=14, fig.height=12, dpi=100}
# ひと月のカレンダーを作図:(休日のセル色を変更)
calendar_fill <- ggplot() + 
  # geom_tile(data = calendar_df,
  #           mapping = aes(x = dow_idx, y = week_idx),
  #           fill = "white", color = "black") + # 平日セル
  geom_tile(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx, fill = date_type), 
            color = "black", alpha = 0.1) + # 休日セル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx-0.4, y = week_idx-0.4, label = day), 
            size = 10, hjust = 0, vjust = 1) + # 日付ラベル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx+0.45, y = week_idx-0.4, label = holiday_label), 
            size = 5, hjust = 1, vjust = 1, na.rm = TRUE) + # 祝日ラベル
  scale_x_continuous(breaks = 1:7, labels = NULL, 
                     sec.axis = dup_axis(trans = ~., labels = dow_label_vec)) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  scale_fill_manual(breaks = c("weekday", "holiday", "weekend"), 
                    values = c("white", "red", "blue")) + # 休日用の塗りつぶし色
  coord_fixed(ratio = 1, expand = FALSE) + # 描画領域
  theme(
    axis.title = element_blank(), # 軸ラベル
    axis.text.x = element_text(size = 30), # 横軸目盛ラベル
    axis.text.y = element_blank(), # 縦軸目盛ラベル
    axis.ticks = element_blank(), # 軸目盛指示線
    panel.grid.major = element_blank(), # 主グリッド線
    panel.grid.minor = element_blank(), # 副グリッド線
    panel.border = element_rect(fill = NA), # グラフ領域の枠線
    panel.background = element_blank(), # グラフ領域の背景
    plot.title = element_text(size = 25, face = "bold"), # タイトル
    plot.subtitle = element_text(size = 50, face = "bold", hjust = 0.5), # サブタイトル
    legend.position = "none" # 凡例の位置
  ) + # 図の体裁
  labs(title = paste0(year, "年"), 
       subtitle = paste0(month, "月"), 
       x = "曜日", y = "週")
calendar_fill
```

　`geom_tile()`の`fill`引数で、日付カテゴリ(`date_type`列の値)ごとにセルの色を塗りつぶして色分けする。カテゴリごとの色は`scale_fill_manual()`で設定できる。`breaks`引数に`fill`引数に指定された値(`date_type`列の値)、`values`引数に割り当てる色を指定する。\
　`theme()`の`panel.background`引数で背景色を白にしない場合は、別の`geom_tile()`を使って全ての日付のセルを白にしておく必要がある。\

　`scale_x_continuous()`で、横軸目盛ラベルとして曜日を表示する。`labels`引数に`NULL`を指定して第1軸(下側)のラベルを非表示にして、`sec.axis`引数に`dup_axis()`を使って`label`引数に文字列を指定して第2軸(上側)のラベルを表示する。\

　日付の文字色を変更して休日を示すカレンダーを作成する。

```{r, fig.width=14, fig.height=12, dpi=100}
# ひと月のカレンダーを作図:(休日のラベル色を変更)
calendar_color <- ggplot() + 
  geom_tile(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            fill = "white", color = "black") + # 日付セル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx-0.4, y = week_idx-0.4, label = day, color = date_type), 
            size = 10, hjust = 0, vjust = 1) + # 日付ラベル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx+0.45, y = week_idx-0.4, label = holiday_label), 
            size = 5, color = "red", hjust = 1, vjust = 1, na.rm = TRUE) + # 祝日ラベル
  scale_x_continuous(breaks = 1:7, labels = NULL, 
                     sec.axis = dup_axis(trans = ~., labels = dow_label_vec)) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  scale_color_manual(breaks = c("weekday", "holiday", "weekend"), 
                     values = c("black", "red", "blue")) + # 休日用文字色
  coord_fixed(ratio = 1, expand = FALSE) + # 描画領域
  theme(
    axis.title = element_blank(), # 軸ラベル
    axis.text.x = element_text(size = 30), # 横軸目盛ラベル
    axis.text.y = element_blank(), # 縦軸目盛ラベル
    axis.ticks = element_blank(), # 軸目盛指示線
    panel.grid.major = element_blank(), # 主グリッド線
    panel.grid.minor = element_blank(), # 副グリッド線
    panel.border = element_rect(fill = NA), # グラフ領域の枠線
    #panel.background = element_blank(), # グラフ領域の背景
    plot.title = element_text(size = 25, face = "bold"), # タイトル
    plot.subtitle = element_text(size = 50, face = "bold", hjust = 0.5), # サブタイトル
    legend.position = "none" # 凡例の位置
  ) + # 図の体裁
  labs(title = paste0(year, "年"), 
       subtitle = paste0(month, "月"), 
       x = "曜日", y = "週")
calendar_color
```

　`geom_text()`の`color`引数で、日付カテゴリ(`date_type`列の値)ごとに日にちラベルの文字色を変更して色分けする。カテゴリごとの色は`scale_txet_manual()`で設定できる。\
\

　以上で、カレンダーを作成できた。次は利用例として、カレンダー上に予定を表示する。\
\


### 利用例

　スケジュールを指定する。

```{r}
# 予定日の暦データを作成
schedule_df <- tibble::tibble(
  date = c("2", "19", "22") |> # 日にちを指定
    (\(.){paste0(year, "-", month, "-", .)})() |> # 日付を作成
    lubridate::as_date(), 
  symbol = c("⚾", "🍈", "🎷") # 予定ラベルを指定
) |> 
  dplyr::left_join(
    calendar_df |> 
      dplyr::select(date, dow_idx, week_idx), 
    by = "date"
  ) # 作図用の値を結合
schedule_df
```

　日付と文字列をデータフレームに格納する。\
　`calendar_df`の曜日番号と週番号を`left_join()`で日付に応じて割り当てる。\

　スケジュールを表示したカレンダーを作成する。

```{r, fig.width=14, fig.height=12, dpi=100}
# スケジュールを重ねたカレンダーを作成
calendar_fill + 
  geom_text(data = schedule_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = symbol), 
            size = 15) # 予定ラベル
```

　作成したグラフ上に`geom_text()`で予定ラベルを描画する。\
\


## ひと年のカレンダー

　次は、1年のカレンダーを作成する。\
\


### 基本形

　作成するカレンダーの年と、週の始まりの曜日を指定する。

```{r}
# 年を指定
year <- 2023

# 週初めの曜日を指定:(月: 1, ..., 日: 7)
dow_start_idx <- 7

# 土曜・日曜の曜日インデックスを設定
dow_sat_idx <- ifelse(dow_start_idx == 7, yes = 7, no = 7 - dow_start_idx)
dow_sun_idx <- 8 - dow_start_idx
dow_sat_idx; dow_sun_idx
```

　年を`year`として整数を指定する。\
　「ひと月のカレンダー」のときのコードで週始めの曜日を指定する。\

　日付データを作成する。

```{r}
# ひと年の暦データを作成
date_df <- tibble::tibble(
  # 1日間隔の日付を作成
  date = seq(
    from = paste0(year, "-1-1") |> 
      lubridate::as_date(), # 正月
    to   = paste0(year, "-12-31") |> 
      lubridate::as_date(), # 大晦日
    by = "day"
  )
) |> 
  dplyr::mutate(
    year  = lubridate::year(date),  # 年ラベル
    month = lubridate::month(date), # 月ラベル
    day   = lubridate::day(date),   # 日ラベル
    # 作図用の値を作成
    dow_idx   = lubridate::wday(date, week_start = dow_start_idx), # 曜日番号(列インデックス)
    dow_label = lubridate::wday(date, week_start = dow_start_idx, label = TRUE) # 曜日ラベル
  ) |> 
  dplyr::group_by(year, month) |> # インデックスの作成用
  dplyr::mutate(
    cell_idx = day + head(dow_idx, n = 1) - 1, # セルインデックス
    week_idx = (cell_idx - 1) %/% 7 + 1 # 週番号(行インデックス)
  ) |> 
  dplyr::ungroup()
date_df
```

　指定した年の正月から大晦日までの日付を作成して、データフレームに格納する。\
　日付ごとに、`year()`で年列、`month()`で月列、`day()`で日にち列を作成する。\
　「ひと月のカレンダー」のときと同様に、曜日番号と週番号を作成する。ただし、週番号列は、年列と月列でグループ化して、月ごとに作成する。\

　1年分(12か月分)のカレンダーの原型を作成する。

```{r, fig.width=12, fig.height=9, dpi=100}
# 横軸ラベルを作成
dow_label_vec <- lubridate::wday(1:7, week_start = dow_start_idx, label = TRUE) |> # 日本語名
  sort()
# dow_label_vec <- lubridate::wday(1:7, week_start = dow_start_idx, label = TRUE, abbr = TRUE, locale = "en_US") |> # 英語名の省略形
#   sort()

# ひと年のカレンダーを作図:(原型)
ggplot() + 
  geom_tile(data = date_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            fill = "white", color = "black") + # 日付セル
  geom_text(data = date_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = day), 
            size = 5) + # 日付ラベル
  scale_x_continuous(breaks = 1:7, labels = dow_label_vec) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  facet_wrap(month ~ ., labeller = "label_both") + # 月ごとに分割
  coord_fixed(ratio = 1) + # アスペクト比
  theme(panel.grid.minor = element_blank()) + # 図の体裁
  labs(title = paste0(year, "年のカレンダー"), 
       x = "曜日", y = "週")
```

　`facet_wrap()`に`month`列を指定して、月ごとに分割して描画する。\
\

　続いて、祝日とカレンダーの体裁を設定する。\
\


### 装飾

　祝日データを作成する。

```{r}
# 祝日情報を取得
holiday_vec <- zipangu::jholiday(year = year, lang = "jp") |> 
  unlist() |> 
  lubridate::as_date()

# 祝日の暦データを作成
tmp_holiday_df <- tibble::tibble(
  date = holiday_vec, # 祝日の日付
  holiday_label = names(holiday_vec), # 祝日ラベル
  dow_idx = lubridate::wday(date, week_start = dow_start_idx) # 振替休日の作成用
)

# 祝日ラベルの文字数を指定
threshold <- 5

# 振替休日の暦データを作成
holiday_df <- tmp_holiday_df |> 
  dplyr::filter(dow_idx == dow_sun_idx) |> # 日曜日の祝日を抽出
  dplyr::mutate(
    date = dplyr::case_when(
      holiday_label == "憲法記念日" ~ date + lubridate::days(3), 
      holiday_label == "みどりの日" ~ date + lubridate::days(2), 
      TRUE ~ date + lubridate::days(1)
    ), # 日にち
    holiday_label = "振替休日", # 祝日名
    dow_idx = lubridate::wday(date, week_start = dow_start_idx) # 祝日データの結合用
  ) |> 
  dplyr::bind_rows(tmp_holiday_df) |> # 祝日の暦データを結合
  dplyr::mutate(
    label_size = dplyr::if_else(
      condition = nchar(holiday_label) <= threshold, 
      true  = "normal", 
      false = "small"
    ) # ラベルサイズカテゴリ:(日付ラベルと祝日ラベルが重なる対策)
  ) |> 
  dplyr::select(date, holiday_label, label_size) |> # 日付データの結合用
  dplyr::arrange(date)
holiday_df
```

　「ひと月のカレンダー」のときと同様にして、祝日の日付と名前をデータフレームに格納する。また、振替休日のデータフレームを作成する。\

　グラフサイズなどによっては、祝日名が日付ラベルに重なって表示される。\
　そこで、文字数の閾値を`threshold`として、祝日名の文字数によってラベルサイズカテゴリを設定する。\

　日付データに休日データを追加する。

```{r}
# 装飾用の暦データを作成
calendar_df <- date_df |> 
  dplyr::left_join(holiday_df, by = "date") |> # 祝日データを結合
  dplyr::mutate(
    date_type = dplyr::case_when(
      !is.na(holiday_label) ~ "holiday", 
      dow_idx == dow_sun_idx ~ "holiday", 
      dow_idx == dow_sat_idx ~ "weekend", 
      TRUE ~ "weekday"
    ) # 日付カテゴリ
  )
calendar_df
```

　「ひと月のカレンダー」のときのコードで処理する。\

　ファセットラベルの設定用の関数を作成する。

```{r}
# ラベル用の関数を作成
str_month <- function(string) {
  paste0(string, "月") # 月の日本語名を出力
  # paste0("2000-", string, "-1") |> # 指定した月の適当な日付を作成
  #   as.Date() |> # 日付型に変換
  #   lubridate::month(label = TRUE, abbr = FALSE, locale = "en_US") |>  # 月の英語名に変換
  #   as.character() # 文字列型に変換して出力
}
str_month(5)
```

　月を示す整数の文字列を受け取り、`n月`の形(または英語名)にして返す関数を定義する。\
　または、月名列を用意してグラフの分割に使うと、月名がファセットラベルに表示される。\

　セルを塗りつぶして休日を示すカレンダーを作成する。

```{r, fig.width=40, fig.height=30, dpi=100}
# ひと年のカレンダーを作図:(休日のセル色を変更)
calendar_fill <- ggplot() + 
  # geom_tile(data = calendar_df, 
  #           mapping = aes(x = dow_idx, y = week_idx), 
  #           fill = "white", color = "black") + # 平日セル
  geom_tile(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx, fill = date_type), 
            color = "black", alpha = 0.1) + # 休日セル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx-0.4, y = week_idx-0.4, label = day), 
            size = 10, hjust = 0, vjust = 1) + # 日付ラベル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx+0.45, y = week_idx-0.4, label = holiday_label, size = label_size), 
            hjust = 1, vjust = 1, na.rm = TRUE) + # 祝日ラベル
  scale_x_continuous(breaks = 1:7, labels = NULL, 
                     sec.axis = dup_axis(trans = ~., labels = dow_label_vec)) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  scale_fill_manual(breaks = c("weekday", "holiday", "weekend"), 
                    values = c("white", "red", "blue")) + # 休日用塗りつぶし色
  scale_size_manual(breaks = c("normal", "small"), 
                    values = c(4, 3)) + # (日付ラベルと祝日ラベルが重なる対策)
  facet_wrap(month ~ ., nrow = 3, ncol = 4, 
             labeller = labeller(month = str_month), scales = "free_x") + # 年・月ごとに分割
  coord_cartesian(expand = FALSE) + # 描画領域
  theme(
    axis.title = element_blank(), # 軸ラベル
    axis.text.x = element_text(size = 30), # 横軸目盛ラベル
    axis.text.y = element_blank(), # 縦軸目盛ラベル
    axis.ticks = element_blank(), # 軸目盛指示線
    panel.grid.major = element_blank(), # 主グリッド線
    panel.grid.minor = element_blank(), # 副グリッド線
    panel.border = element_rect(fill = NA), # グラフ領域の枠線
    panel.background = element_blank(), # グラフ領域の背景
    plot.title = element_text(size = 50, face = "bold", hjust = 0.5), # タイトル
    strip.text = element_text(size = 50, face = "bold"), # ファセットラベルの文字
    strip.background = element_blank(), # ファセットラベル領域の背景
    strip.placement = "outside", # ファセットラベルの位置
    legend.position = "none" # 凡例の位置
  ) + # 図の体裁
  labs(title = paste0(year, "年"), 
       x = "曜日", y = "週")
calendar_fill
```

　`facet_wrap()`の`labeller`引数に`labeller()`を使ってファセットラベルを設定できる。\

　日付の文字色を変更して休日を示すカレンダーを作成する。

```{r, fig.width=40, fig.height=30, dpi=100}
# ひと年のカレンダーを作図:(休日のラベル色を変更)
calendar_color <- ggplot() + 
  geom_tile(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            fill = "white", color = "black") + # 日付セル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx-0.4, y = week_idx-0.4, label = day, color = date_type), 
            size = 10, hjust = 0, vjust = 1) + # 日付ラベル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx+0.45, y = week_idx-0.4, label = holiday_label, size = label_size), 
            color = "red", hjust = 1, vjust = 1, na.rm = TRUE) + # 祝日ラベル
  scale_x_continuous(breaks = 1:7, labels = NULL, 
                     sec.axis = dup_axis(trans = ~., labels = dow_label_vec)) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  scale_color_manual(breaks = c("weekday", "holiday", "weekend"), 
                     values = c("black", "red", "blue")) + # 休日用文字色
  scale_size_manual(breaks = c("normal", "small"), 
                    values = c(4, 3)) + # (日付ラベルと祝日ラベルが重なる対策)
  facet_wrap(month ~ ., nrow = 3, ncol = 4, 
             labeller = labeller(month = str_month), scales = "free_x") + # 年・月ごとに分割
  coord_cartesian(expand = FALSE) + # 描画領域
  theme(
    axis.title = element_blank(), # 軸ラベル
    axis.text.x = element_text(size = 30), # 横軸目盛ラベル
    axis.text.y = element_blank(), # 縦軸目盛ラベル
    axis.ticks = element_blank(), # 軸目盛指示線
    panel.grid.major = element_blank(), # 主グリッド線
    panel.grid.minor = element_blank(), # 副グリッド線
    panel.border = element_rect(fill = NA), # グラフ領域の枠線
    #panel.background = element_blank(), # グラフ領域の背景
    plot.title = element_text(size = 50, face = "bold", hjust = 0.5), # タイトル
    strip.text = element_text(size = 50, face = "bold"), # ファセットラベルの文字
    strip.background = element_blank(), # ファセットラベル領域の背景
    strip.placement = "outside", # ファセットラベルの位置
    legend.position = "none" # 凡例の位置
  ) + # 図の体裁
  labs(title = paste0(year, "年"), 
       x = "曜日", y = "週")
calendar_color
```

　これまでと同様にして作図する。\
\

　以上で、カレンダーを作成できた。次は利用例として、カレンダー上に予定を表示する。\
\


### 利用例

　誕生日データを作成する。

<details><summary>・コード(クリックで展開)</summary>

　ハロプロデータを読み込む。

```{r}
# フォルダパスを指定
dir_path <- "../../Hello/ChartRace/data/HP_DB-main/"

# 加入・卒業日一覧を読み込み
join_df <- readr::read_csv(
  file = paste0(dir_path, "join.csv"), 
  col_types = readr::cols(
    memberID = "i", 
    groupID = "i", 
    joinDate = readr::col_date(format = "%Y/%m/%d"), 
    gradDate = readr::col_date(format = "%Y/%m/%d")
  )
) |> 
  dplyr::arrange(joinDate, memberID, groupID)

# メンバー一覧を読み込み
member_df <- readr::read_csv(
  file = paste0(dir_path, "member.csv"), 
  col_types = readr::cols(
    memberID = "i", 
    memberName = "c", 
    HPjoinDate = readr::col_date(format = "%Y/%m/%d"), 
    debutDate = readr::col_date(format = "%Y/%m/%d"), 
    HPgradDate = readr::col_date(format = "%Y/%m/%d"), 
    memberKana = "c", 
    birthDate = readr::col_date(format = "%Y/%m/%d")
  )
) |> 
  dplyr::select(memberID, memberName, birthDate) |> 
  dplyr::distinct() |> 
  dplyr::arrange(memberID)
join_df; member_df
```

　グループ加入情報を`join_df`、メンバー情報を`member_df`としてそれぞれ読み込む。詳しくは「ハロプロチャートレースシリーズ」を参照のこと。\

　誕生日データを作成する。

```{r}
# グループを指定
group_id <- 1

# 予定の暦データを作成
schedule_df <- join_df |> 
  dplyr::filter(groupID == group_id) |> # 指定グループの加入情報を抽出
  dplyr::left_join(member_df, by = "memberID") |> # 誕生日情報を結合
  dplyr::mutate(
    month = lubridate::month(birthDate), # 誕生月
    day   = lubridate::day(birthDate),   # 誕生日(日にち)
    date  = paste0(year, "-", as.character(month), "-", as.character(day)) |> 
      lubridate::as_date(), # 指定した年の誕生日
    symbol = "🎂" # 記号を指定
  ) |> 
  dplyr::select(date, symbol, memberName, month) |> 
  dplyr::left_join(
    calendar_df |> 
      dplyr::select(date, dow_idx, week_idx), 
    by = "date"
  ) |> # 作図用の値を結合
  dplyr::arrange(date)
schedule_df
```

　グループIDを指定して、`join_df`から所属メンバーのIDを抽出する。メンバーIDに応じて、`member_df`から誕生日情報(生年月日)を結合する。\
　指定した年の誕生日(月日)を作成して、`calendar_df`から対応する曜日番号と週番号を結合する。\

</details>

　スケジュールを表示したカレンダーを作成する。

```{r, fig.width=40, fig.height=30, dpi=100}
# スケジュールを重ねたカレンダーを作成
calendar_fill + 
  geom_text(data = schedule_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = symbol), 
            size = 15) + # 予定マーク
  geom_text(data = schedule_df, 
            mapping = aes(x = dow_idx, y = week_idx+0.45, label = memberName), 
            size = 5, vjust = 0) # 予定ラベル
```

　「ひと月のカレンダー」のときと同様に、予定を表すマークとラベルを描画する。\
\


## 任意の期間のカレンダー

　最後は、期間を指定して(1日から始まらない場合の)カレンダーを作成する。\
\


### 基本形

　作成するカレンダーの期間と、週の始まりの曜日を指定する。

```{r}
# 開始日を指定
date_from <- "2021-05-05" |> 
  lubridate::as_date()

# 終了日を指定
date_to <- "2023-05-04" |> 
  lubridate::as_date()

# 週初めの曜日を指定:(月: 1, ..., 日: 7)
dow_start_idx <- 7

# 土曜・日曜の曜日インデックスを設定
dow_sat_idx <- ifelse(dow_start_idx == 7, yes = 7, no = 7 - dow_start_idx)
dow_sun_idx <- 8 - dow_start_idx
dow_sat_idx; dow_sun_idx
```

　期間の開始日を`date_from`、終了日を`date_to`として日付型の値を指定する。\
　「ひと月のカレンダー」のときのコードで週始めの曜日を指定する。\

　日付データを作成する。

```{r}
# 任意期間の暦データを作成
date_df <- tibble::tibble(
  # 1日間隔の日付を作成
  date = seq(
    from = date_from |> 
      lubridate::floor_date(unit = "month"), # 開始日の月の初日
    to   = date_to, # 終了日
    by = "day"
  )
) |> 
  dplyr::mutate(
    year  = lubridate::year(date),  # 年ラベル
    month = lubridate::month(date), # 月ラベル
    day   = lubridate::day(date),   # 日ラベル
    # 作図用の値を作成
    dow_idx   = lubridate::wday(date, week_start = dow_start_idx), # 曜日番号(列インデックス)
    dow_label = lubridate::wday(date, week_start = dow_start_idx, label = TRUE) # 曜日ラベル
  ) |> 
  dplyr::group_by(year, month) |> # インデックスの作成用
  dplyr::mutate(
    cell_idx = dplyr::if_else(
      condition = date >= date_from, # 指定期間の場合
      true  = day + head(dow_idx, n = 1) - 1, 
      false = NA_real_
    ), # セルインデックス
    week_idx = dplyr::if_else(
      condition = date >= date_from, # 指定期間の場合
      true  = (cell_idx - 1) %/% 7 + 1, 
      false = NA_real_
    ) # 週番号(行インデックス)
  ) |> 
  dplyr::ungroup() |> 
  dplyr::filter(date >= date_from) # 期間外のデータを除去
date_df
```

　開始日の月初から終了日までの日付を作成して、データフレームに格納する。期間前の日付は、週番号の計算に用いる。\
　「ひと年のカレンダー」のときと同様に、年列・月列と曜日番号列・週番号列を作成する。ただし、開始日以前のデータについては、インデックス(数値型の)欠損値にするか、インデックスの計算後に取り除く。この例では、両方の処理を行っている。\

　月ごとのカレンダーの原型を作成する。

```{r, fig.width=12, fig.height=12, dpi=100}
# 横軸ラベルを作成
dow_label_vec <- lubridate::wday(1:7, week_start = dow_start_idx, label = TRUE) |> # 日本語名
  sort()
#dow_label_vec <- lubridate::wday(1:7, week_start = dow_start_idx, label = TRUE, abbr = TRUE, locale = "en_US") |> # 英語名の省略形
#  sort()

# タイトル用の文字列を作成
title_label <- paste0(
  format(date_from, format = "%Y年%m月%d日"), "から", 
  format(date_to, format = "%Y年%m月%d日"), "までのカレンダー"
)

# 任意期間のカレンダーを作図:(原型)
ggplot() + 
  geom_tile(data = date_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            fill = "white", color = "black") + # 日付セル
  geom_text(data = date_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = day), 
            size = 5) + # 日付ラベル
  scale_x_continuous(breaks = 1:7, labels = dow_label_vec) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  coord_fixed(ratio = 1) + # アスペクト比
  facet_wrap(year ~ month, labeller = "label_both") + # 月ごとに分割
  #facet_grid(year ~ month, labeller = "label_both", switch = "y") + # 年・月ごとに分割
  theme(panel.grid.minor = element_blank()) + # 図の体裁
  labs(title = title_label, 
       x = "曜日", y = "週")
```

```{r, echo=FALSE, fig.width=24, fig.height=6, dpi=100}
### 資料作成用:(再掲)

# 任意期間のカレンダーを作図:(原型)
ggplot() + 
  geom_tile(data = date_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            fill = "white", color = "black") + # 日付セル
  geom_text(data = date_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = day), 
            size = 5) + # 日付ラベル
  scale_x_continuous(breaks = 1:7, labels = dow_label_vec) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  coord_fixed(ratio = 1) + # アスペクト比
  #facet_wrap(year ~ month, labeller = "label_both") + # 月ごとに分割
  facet_grid(year ~ month, labeller = "label_both", switch = "y") + # 年・月ごとに分割
  theme(panel.grid.minor = element_blank()) + # 図の体裁
  labs(title = title_label, 
       x = "曜日", y = "週")
```

　`facet_wrap()`で月ごとに、または`facet_grid()`で年と月ごとに分割して描画する。\
\

　続いて、祝日とカレンダーの体裁を設定する。\
\


### 装飾

　祝日データを取得する。

```{r}
# 祝日情報を取得
holiday_vec <- zipangu::jholiday(
  year = lubridate::year(date_from):lubridate::year(date_to), lang = "jp"
) |> 
  unlist() |> 
  lubridate::as_date()
head(holiday_vec)
```

　`jholiday()`の`year`引数に期間内の年を指定する。複数年を指定した場合は、祝日名の後に通し番号が付く。\

　祝日データを格納する。

```{r}
# 祝日の暦データを作成
tmp_holiday_df <- tibble::tibble(
  date = holiday_vec, # 祝日の日付
  holiday_label = holiday_vec |> 
    names() |> 
    stringr::str_remove(pattern = "\\d"), # 祝日ラベル
  dow_idx = lubridate::wday(date, week_start = dow_start_idx) # 振替休日の作成用
) |> 
  dplyr::filter(dplyr::between(date, left = date_from, right = date_to)) |>  # 期間内のデータを抽出
  dplyr::arrange(date)
tmp_holiday_df
```

　`str_remove()`で通し番号を取り除いて、祝日名を格納する。\
　指定期間のデータを`between()`で抽出する。\

　「ひと月のカレンダー」のときのコードで、振替休日を追加して、カレンダーの作図用のデータを作成する。

```{r, echo=FALSE}
### 資料作成用:(再掲)

# 振替休日の暦データを作成
holiday_df <- tmp_holiday_df |> 
  dplyr::filter(dow_idx == dow_sun_idx) |> # 日曜日の祝日を抽出
  dplyr::mutate(
    date = dplyr::case_when(
      holiday_label == "憲法記念日" ~ date + lubridate::days(3), 
      holiday_label == "みどりの日" ~ date + lubridate::days(2), 
      TRUE ~ date + lubridate::days(1)
    ), # 日にち
    holiday_label = "振替休日", # 祝日名
    dow_idx = lubridate::wday(date, week_start = dow_start_idx) # 祝日データの結合用
  ) |> 
  dplyr::bind_rows(tmp_holiday_df) |> # 祝日の暦データを結合
  dplyr::select(date, holiday_label, holiday_label) |> # 日付データの結合用
  dplyr::arrange(date)

# 装飾用の暦データを作成
calendar_df <- date_df |> 
  dplyr::left_join(holiday_df, by = "date") |> # 祝日データを結合
  dplyr::mutate(
    date_type = dplyr::case_when(
      !is.na(holiday_label) ~ "holiday", 
      dow_idx == dow_sun_idx ~ "holiday", 
      dow_idx == dow_sat_idx ~ "weekend", 
      TRUE ~ "weekday"
    ) # 日付カテゴリ
  )
```

```{r}
# 確認
calendar_df
```

\ 

　ファセットラベルの設定用の関数を作成する。

```{r}
# ラベル用の関数を作成
str_year <- function(string) {
  paste0(string, "年")
}
str_month <- function(string) {
  paste0(string, "月")
}
str_year(lubridate::year(date_from)); str_month(lubridate::month(date_from))
```

　年を受け取り`m年`を返す関数と、月を受け取り`n月`を返す関数を定義する。英語名の月を表示する場合は「ひと年のカレンダー」のときの関数を使う。\

　セルを塗りつぶして休日を示すカレンダーを作成する。

```{r, fig.width=40, fig.height=10, dpi=100}
# 任意期間のカレンダーを作図:(休日のラベル色を変更)
ggplot() + 
  geom_tile(data = calendar_df,
            mapping = aes(x = dow_idx, y = week_idx),
            fill = "white", color = "black") + # 平日セル
  geom_tile(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx, fill = date_type), 
            color = "black", alpha = 0.1) + # 休日セル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx-0.4, y = week_idx-0.4, label = day), 
            size = 3, hjust = 0, vjust = 1) + # 日付ラベル
  scale_x_continuous(breaks = 1:7, labels = dow_label_vec) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  scale_fill_manual(breaks = c("weekday", "holiday", "weekend"), 
                     values = c("white", "red", "blue")) + # 休日用塗りつぶし色
  facet_grid(year ~ month, labeller = labeller(year = str_year, month = str_month), switch = "y") + # 年・月ごとに分割
  coord_fixed(ratio = 1, expand = FALSE) + # 描画領域
  theme(
    axis.title = element_blank(), # 軸ラベル
    axis.text.x = element_text(size = 10), # 横軸目盛ラベル
    axis.text.y = element_blank(), # 縦軸目盛ラベル
    axis.ticks = element_blank(), # 軸目盛指示線
    #panel.grid.major = element_blank(), # 主グリッド線
    panel.grid.minor = element_blank(), # 副グリッド線
    panel.border = element_rect(fill = NA), # グラフ領域の枠線
    #panel.background = element_blank(), # グラフ領域の背景
    strip.text = element_text(size = 15, face = "bold"), # ファセットラベルの文字
    strip.background = element_blank(), # ファセットラベル領域の背景
    strip.placement = "outside", # ファセットラベルの位置
    legend.position = "none" # 凡例の位置
  ) + # 図の体裁
  labs(x = "曜日", y = "週")
```

　これまでと同様にして作図する。\

　日付の文字色を変更して休日を示すカレンダーを作成する。

```{r, fig.width=40, fig.height=10, dpi=100}
# 任意期間のカレンダーを作図:(休日のラベル色を変更)
ggplot() + 
  geom_tile(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            fill = "white", color = "black") + # 日付セル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx-0.4, y = week_idx-0.4, label = day, color = date_type), 
            size = 3, hjust = 0, vjust = 1) + # 日付ラベル
  scale_x_continuous(breaks = 1:7, labels = dow_label_vec) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  scale_color_manual(breaks = c("weekday", "holiday", "weekend"), 
                     values = c("black", "red", "blue")) + # 休日用文字色
  facet_grid(year ~ month, labeller = labeller(year = str_year, month = str_month), switch = "y") + # 年・月ごとに分割
  coord_fixed(ratio = 1, expand = FALSE) + # 描画領域
  theme(
    axis.title = element_blank(), # 軸ラベル
    axis.text.x = element_text(size = 10), # 横軸目盛ラベル
    axis.text.y = element_blank(), # 縦軸目盛ラベル
    axis.ticks = element_blank(), # 軸目盛指示線
    #panel.grid.major = element_blank(), # 主グリッド線
    panel.grid.minor = element_blank(), # 副グリッド線
    panel.border = element_rect(fill = NA), # グラフ領域の枠線
    #panel.background = element_blank(), # グラフ領域の背景
    strip.text = element_text(size = 15, face = "bold"), # ファセットラベルの文字
    strip.background = element_blank(), # ファセットラベル領域の背景
    strip.placement = "outside", # ファセットラベルの位置
    legend.position = "none" # 凡例の位置
  ) + # 図の体裁
  labs(x = "曜日", y = "週")
```

\ 

　以上で、カレンダーを作成できた。次は利用例として、カレンダー上にヒートマップを表示する。\
\


### 利用例

　ブログ記事の投稿日データを作成する。\

<details><summary>・コード(クリックで展開)</summary>

　記事URLデータを読み込む。

```{r}
# ファイルパスを指定
file_path <- "../data/url.rds"

# URLデータを読み込み
url_vec <- readRDS(file = file_path)
head(url_vec)
```

　詳しくは「登山本シリーズの6章」を参照のこと。\

　投稿日データを作成する。

```{r}
# ブログのURLを指定
blog_url <- "https://www.anarchive-beta.com/"

# 投稿日を抽出
date_vec <- url_vec |> 
  stringr::str_remove(pattern = paste0(blog_url, "entry/")) |> # 日時を示す文字列を抽出
  lubridate::as_datetime(tz = "Asia/Tokyo") |> # タイムゾーンを設定
  lubridate::as_date() |> 
  sort()
head(date_vec)
```

　記事URLからベースとなるブログURLなどの文字列を取り除き、投稿時間を示す文字列を作成する。\
　`as_datetime()`で日時型に変換してタイムゾーンを設定して、`as_date()`で日付型に変換する。\

　カレンダーの期間を設定する。

```{r}
# 期間を設定
date_from <- min(date_vec)
#date_to   <- max(date_vec)
date_to   <- lubridate::today()
date_from; date_to
```

　最初の投稿日を`date_from`、最新の投稿日または現在の日付を`date_to`とする。\

　「基本形」と「装飾」のときのコードで、カレンダーの作図用のデータを作成する。

```{r, echo=FALSE}
### 資料作成用:(再掲)

# 任意期間の暦データを作成
date_df <- tibble::tibble(
  # 1日間隔の日付を作成
  date = seq(
    from = date_from |> 
      lubridate::floor_date(unit = "month"), # 開始日の月の初日
    to   = date_to, # 終了日
    by = "day"
  )
) |> 
  dplyr::mutate(
    year  = lubridate::year(date),  # 年ラベル
    month = lubridate::month(date), # 月ラベル
    day   = lubridate::day(date),   # 日ラベル
    # 作図用の値を作成
    dow_idx   = lubridate::wday(date, week_start = dow_start_idx), # 曜日番号(列インデックス)
    dow_label = lubridate::wday(date, week_start = dow_start_idx, label = TRUE) # 曜日ラベル
  ) |> 
  dplyr::group_by(year, month) |> # インデックスの作成用
  dplyr::mutate(
    cell_idx = dplyr::if_else(
      condition = date >= date_from, # 指定期間の場合
      true  = day + head(dow_idx, n = 1) - 1, 
      false = NA_real_
    ), # セルインデックス
    week_idx = dplyr::if_else(
      condition = date >= date_from, # 指定期間の場合
      true  = (cell_idx - 1) %/% 7 + 1, 
      false = NA_real_
    ) # 週番号(行インデックス)
  ) |> 
  dplyr::ungroup() |> 
  dplyr::filter(date >= date_from) # 期間外のデータを除去

# 祝日情報を取得
holiday_vec <- zipangu::jholiday(
  year = lubridate::year(date_from):lubridate::year(date_to), lang = "jp"
) |> 
  unlist() |> 
  lubridate::as_date()

# 祝日の暦データを作成
tmp_holiday_df <- tibble::tibble(
  date = holiday_vec, # 祝日の日付
  holiday_label = holiday_vec |> 
    names() |> 
    stringr::str_remove(pattern = "\\d"), # 祝日ラベル
  dow_idx = lubridate::wday(date, week_start = dow_start_idx) # 振替休日の作成用
) |> 
  dplyr::filter(dplyr::between(date, left = date_from, right = date_to)) |>  # 期間内のデータを抽出
  dplyr::arrange(date)

# 振替休日の暦データを作成
holiday_df <- tmp_holiday_df |> 
  dplyr::filter(dow_idx == dow_sun_idx) |> # 日曜日の祝日を抽出
  dplyr::mutate(
    date = dplyr::case_when(
      holiday_label == "憲法記念日" ~ date + lubridate::days(3), 
      holiday_label == "みどりの日" ~ date + lubridate::days(2), 
      TRUE ~ date + lubridate::days(1)
    ), # 日にち
    holiday_label = "振替休日", # 祝日名
    dow_idx = lubridate::wday(date, week_start = dow_start_idx) # 祝日データの結合用
  ) |> 
  dplyr::bind_rows(tmp_holiday_df) |> # 祝日の暦データを結合
  dplyr::select(date, holiday_label, holiday_label) |> # 日付データの結合用
  dplyr::arrange(date)

# 装飾用の暦データを作成
calendar_df <- date_df |> 
  dplyr::left_join(holiday_df, by = "date") |> # 祝日データを結合
  dplyr::mutate(
    date_type = dplyr::case_when(
      !is.na(holiday_label) ~ "holiday", 
      dow_idx == dow_sun_idx ~ "holiday", 
      dow_idx == dow_sat_idx ~ "weekend", 
      TRUE ~ "weekday"
    ) # 日付カテゴリ
  )
```

```{r}
# 確認
calendar_df
```

\ 

　記事の投稿数を集計する。

```{r}
# 記事投稿数を集計
post_df <- tibble::tibble(
  date = date_vec
) |> 
  dplyr::count(date, name = "post") |> # 投稿数をカウント |> 
  dplyr::left_join(
    calendar_df |> 
      dplyr::select(date, year, month, dow_idx, week_idx), 
    by = "date"
  ) |> # 作図用の値を結合
  dplyr::arrange(date)
post_df
```

　重複する日付を`count()`でカウントして投稿数とする。\
　投稿日に応じて、`calendar_df`から曜日番号と週番号を結合する。\

</details>

　記事投稿数のヒートマップを作成する。

```{r, fig.width=40, fig.height=20, dpi=100}
# 横軸ラベルを作成
dow_label_vec <- lubridate::wday(1:7, week_start = dow_start_idx, label = TRUE) # 日本語名

# タイトル用の文字列を作成
title_label <- paste0(
  format(date_from, format = "%Y年%m月%d日"), "から", 
  format(date_to, format = "%Y年%m月%d日"), "のブログ記事投稿数"
)

# 投稿数のヒートマップ
ggplot() + 
  geom_tile(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            fill = "white", color = "black") + # 日付セル
  geom_tile(data = post_df, 
            mapping = aes(x = dow_idx, y = week_idx, fill = post), 
            color = "black") + # 投稿数ヒートマップ
  geom_text(data = post_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = post), 
            size = 5) + # 投稿数ラベル
  geom_label(data = calendar_df, 
             mapping = aes(x = dow_idx-0.5, y = week_idx-0.5, 
                           label = stringr::str_pad(day, side = "left", width = 2, pad = " "), color = date_type), 
             size = 3.5, hjust = 0, vjust = 1, label.padding = unit(0.1, units = "line"), 
             na.rm = TRUE, show.legend = FALSE) + # 日付ラベル
  scale_x_continuous(breaks = 1:7, labels = dow_label_vec) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  scale_color_manual(breaks = c("weekday", "holiday", "weekend"), 
                     values = c("black", "red", "blue")) + # 休日用文字色
  scale_fill_gradient2(low = "gray", mid = "white", high = "green") + # 投稿数グラデーション
  facet_grid(year ~ month, labeller = labeller(year = str_year, month = str_month), switch = "y") + # 年・月ごとに分割
  coord_fixed(ratio = 1, expand = FALSE) + # 描画領域
  theme(
    axis.title = element_blank(), # 軸ラベル
    axis.text.x = element_text(size = 30), # 横軸目盛ラベル
    axis.text.y = element_blank(), # 縦軸目盛ラベル
    axis.ticks = element_blank(), # 軸目盛指示線
    #panel.grid.major = element_blank(), # 主グリッド線
    panel.grid.minor = element_blank(), # 副グリッド線
    panel.border = element_rect(fill = NA), # グラフ領域の枠線
    #panel.background = element_blank(), # グラフ領域の背景
    plot.title = element_text(size = 50, face = "bold", hjust = 0.5), # タイトル
    plot.subtitle = element_text(size = 30, face = "bold", hjust = 1), # サブタイトル
    strip.text = element_text(size = 30, face = "bold"), # ファセットラベルの文字
    strip.background = element_blank(), # ファセットラベル領域の背景
    strip.placement = "outside" # ファセットラベルの位置
  ) + # 図の体裁
  labs(title = title_label, 
       subtitle = paste0("総記事数:", sum(post_df[["post"]])), 
       fill = "投稿数", 
       x = "曜日", y = "週")
```

　カレンダーのグラフ上に、`geom_tile()`で投稿数に応じて色付けするヒートマップを描画する。\
\

　この記事では、カレンダーを作成した。\
\


# 2つの日付間の経過日数(y年mか月とd日)を求めたい

　ある日付からの経過期間(年・月・日数)を「何年何か月と何日」の形式で求めたい。総年数や総月数、総日数であれば`lubridate`パッケージの関数で簡単に求められるが、前月の基準となる日にちからの経過日数を求めるのは(たぶん)ややこしいのでやってみる。簡単に求められるのであれば教えてほしい。\
\

　利用するパッケージを読み込む。

```{r, eval=FALSE}
# 利用パッケージ
library(tidyverse)
library(lubridate)
```

```{r, echo=FALSE}
### 資料作成用

# チェック用
library(ggplot2)
```

　この記事では基本的に、`パッケージ名::関数名()`の記法を使うので、パッケージを読み込む必要はない。ただし、作図コードについてはパッケージ名を省略するため、`ggplot2`を読み込む必要がある。\
　また、`magrittr`パッケージのパイプ演算子`%>%`ではなく、ネイティブパイプ演算子`|>`を使う。`%>%`に置き換えても処理できるが、その場合は`magrittr`を読み込む必要がある。\
\


## 月ごとの経過日数

　まずは簡単な例として、毎月1日時点の経過期間を求める。\
\


### 期間計算

　基準となる日と期間を設定する。

```{r}
# 基準日を指定
date_from <- "2022-01-15" |> 
  lubridate::as_date()

# 期間の最終日を指定
date_max <- "2023-02-15" |> 
  lubridate::as_date()
date_from; date_max
```

　各期間の開始日を`date_from`、期間の最終日(の月)を`date_max`として`"yyyy-mm-dd"`などの形式の文字列で指定して、`as_date()`で日付型の値に変換する。\
　`date_from`を基準日、`date_max`までの日を経過日と呼ぶことにする。\

　月ごとに経過期間を計算する。

```{r}
# 基準日以降の月ごとに経過期間を計算
month_df <- tibble::tibble(
  # 1か月間隔の日付を作成
  date = seq(
    from = date_from |> 
      lubridate::rollforward(roll_to_first = TRUE), # 基準日の翌月の初日
    to = date_max |> 
      lubridate::floor_date(unit = "month"), # 期間の最終日の月の初日
    by = "month"
  )
) |> 
  dplyr::mutate(
    # 期間計算用の値を作成
    date_day = date |> 
      lubridate::day() |> 
      as.numeric(), # 経過日の日にち
    from_day = date_from |> 
      lubridate::day() |> 
      as.numeric(), # 基準日の日にち
    pre_last_day = date |> 
      lubridate::rollback() |> 
      lubridate::day() |> 
      as.numeric(), # 経過日の前月の末日
    # 経過期間を計算
    y = lubridate::interval(start = date_from, end = date) |> 
      lubridate::time_length(unit = "year") |> 
      floor(), # 経過年数
    m = lubridate::interval(start = date_from, end = date) |> 
      lubridate::time_length(unit = "month") |> 
      floor() %% 12, # 経過月数
    d = dplyr::case_when(
      from_day >= pre_last_day ~ 1, # 基準日の日にちが無い月の場合は「1にち」
      from_day == 1 ~ 0, # 基準日が月初の場合は「0にち」
      from_day <= pre_last_day ~ pre_last_day - from_day + 1 # 基準日の日にちが有る月の場合は「前月における基準日からの日数」
    ), # 経過日数
    days = lubridate::interval(start = date_from, end = date) |> 
      lubridate::time_length(unit = "day"), # 総経過日数
    ymd_label = paste0(y, "年", m, "か月", d, "日") # 経過期間ラベル
  )
month_df |> 
  dplyr::select(!date_day) # 資料用に間引き
```

　「`date_from`の翌月の1日」から「`date_max`の月の1日」まで1か月間隔の日付を`seq(by = "month")`で作成して、経過日列`date`としてデータフレームに格納する。\

　条件式や計算用に、経過日の日にちを`date_day`列、基準日の日にちを`from_day`列、経過日の前月末の日にちを`pre_last_day`列としておく。日にちの値は`day()`、前月の月末の日付は`rollback()`で得られる。\

　基準日`date_from`から各経過日`date`までの経過年数を`interval()`と`time_length(unit = "year")`で計算して`y`列とする。\
　総経過月数を`interval()`と`time_length(unit = "month")`で計算して、1年の月数`12`で割った余りを経過月数`m`列とする。商余は`%%`で計算できる。\
　経過日数は、`case_when()`を使って「基準日の日にち」によって場合分けして計算して、`d`列とする。

- 「基準の日にち」が「前月に無い」(`from_day`が`pre_last_day`より大きい)または「前月末の日にち」(`from_day`と`pre_last_day`が同じ)の場合は、基準の日にちを月末とみなして、`1`にちである。
- 「基準の日にち」が「経過日と同じ日にち(1日)」(`from_day`が`1`)の場合は、`0`にちである。
- 「基準の日にち」が「前月に有る(前月末の日にちより前の日にち)」(`from_day`が`pre_last_day`より小さい)場合は、前月の基準の日から月末までの日数(`pre_last_day - from_day`)の`1`にち後である。「基準の日にち」が「前月末の日にち」(`from_day`と`pre_last_day`が同じ)の場合は、こちらの式でも計算できる。\

　総経過日数は`interval()`と`time_length(unit = "day")`で計算できる。\
　経過期間列`y, m, d`を用いて、経過期間ラベルを作成して`ymd_label`列とする。\
\


## 日ごとの経過日数

　続いて、日ごとに経過期間を求める。\
\


### 期間計算

　基準となる日と期間を設定して、日ごとに経過期間を計算する。

```{r}
# 基準日を指定
date_from <- "2022-01-30" |> 
  lubridate::as_date()

# 期間の最終日を指定
date_max <- "2023-02-20" |> 
  lubridate::as_date()

# 基準日以降の日ごとに経過期間を計算
date_df <- tibble::tibble(
  # 1日間隔の日付を作成
  date = seq(from = date_from , to = date_max, by = "day")
) |> 
  dplyr::mutate(
    # 期間計算用の値を作成
    date_day = date |> 
      lubridate::day() |> 
      as.numeric(), # 経過日の日にち
    from_day = date_from |> 
      lubridate::day() |> 
      as.numeric(), # 基準日の日にち
    pre_last_day = date |> 
      lubridate::rollback() |> 
      lubridate::day() |> 
      as.numeric(), # 経過日の前月の末日
    # 経過期間を計算
    y = lubridate::interval(start = date_from, end = date) |> 
      lubridate::time_length(unit = "year") |> 
      floor(), # 経過年数
    m = lubridate::interval(start = date_from, end = date) |> 
      lubridate::time_length(unit = "month") |> 
      floor() %% 12, # 経過月数
    d = dplyr::case_when(
      (from_day > date_day & from_day <  pre_last_day) ~ pre_last_day - from_day + date_day, # 前月の途中から
      (from_day > date_day & from_day >= pre_last_day) ~ date_day, # 当月の頭から
      from_day <= date_day ~ date_day - from_day # 当月の途中から
    ), # 経過日数
    days = lubridate::interval(start = date_from, end = date) |> 
      lubridate::time_length(unit = "day"), # 総経過日数
    ymd_label = paste0(y, "年", m, "か月", d, "日") # 経過期間ラベル
  )
date_df |> 
  dplyr::select(!date_day) # 資料用に間引き
```

　基準日`date_from`と期間の最終日`date_max`を日付型の値で指定する。\
　`date_from`から`date_max`までの1日間隔の日付を`seq(by = "day")`を作成して、経過日列`date`としてデータフレームに格納する。\

　「月ごとの経過日数」のときと同様にして、経過日の日にち列`date_day`、基準日の日にち列`from_day`、経過日の前月末の日にち列`pre_last_day`を作成しておく。\
　また、基準日`date_from`から各経過日`date`までの経過年数列`y`、経過月数列`m`を計算する。\

　経過日数列`d`は、「基準日の日にち」と「経過日の日にち」または「経過日の前月末の日にち」との大小関係によって場合分けして計算する。

- 「経過日の日にち」から「基準の日にち」まで(`form_day`が`date_day`より大きい場合)の日数を、さらに2つの場合に応じて計算する。
    - 「基準の日にち」が「前月に有る(前月末の日にちより前の日にち)」(`from_day`が`pre_last_day`より小さい)場合は、「前月の基準の日から月末までの日数」(`pre_last_day - from_day`)と「当月の経過日数」(`date_day`)の和である。
    - 「基準の日にち」が「前月に無い」(`from_day`が`pre_last_day`より大きい)または「前月末の日にち」(`from_day`と`pre_last_day`が同じ)の場合は、基準の日を月末とみなして、「当月の経過日数」(`date_day`)である。
- 「基準の日にち」から「経過日の日にち」まで(`form_day`が`date_day`以下の場合)の日数は、「当月の基準の日から経過日までの日数」(`date_day - from_day`)である。

　経過日数列`y, m, d`を用いて、経過日数ラベルを作成して`ymd_label`列とする。\
\

　以上で、経過期間を計算できた。続いて、計算結果を確認する。\
\


### ヒートマップで確認

　表形式では計算が合っているのか分かりにくいので、ヒートマップとラベルで確認する。\
\

　ヒートマップの作図用のデータフレームを作成する。

```{r}
# ヒートマップ用に経過期間データを整形
heatmap_df <- date_df |> 
  dplyr::select(date, d, ymd_label, day = date_day) |> 
  dplyr::mutate(
    year_month = date |> 
      format(format = "%Y-%m") |> 
      factor() # 年月ラベル
  )
heatmap_df
```

　この例では、各経過日を1つのセルにするためx軸を年月、y軸を日として、各経過日の前月の基準の日からの日数で濃淡を付けて可視化する。`date`列から年・月部分を`format()`で文字列として取り出す。\

　ヒートマップとラベルで経過期間を確認する。

```{r, fig.width=20, fig.height=10, dpi=100}
# 経過期間をヒートマップで可視化
ggplot() + 
  geom_tile(data = heatmap_df, 
            mapping = aes(x = year_month, y = day, fill = d)) + # 日付セル
  geom_tile(mapping = aes(x = format(date_from, format = "%Y-%m"), y = lubridate::day(date_from)), 
            fill = "blue", color = "blue", alpha = 0.1) + # 基準日セル
  geom_text(data = heatmap_df, 
            mapping = aes(x = year_month, y = day, label = ymd_label)) + # 経過期間ラベル
  scale_y_reverse(breaks = 1:31) + # 日軸
  scale_fill_gradient(low = "white" , high = "#00A968") + # 経過日数のグラデーション:(正の値のみの場合)
  #scale_fill_gradient2(low = "hotpink", mid = "white" , high = "#00A968") + # 経過日数のグラデーション:(負の値を含む場合)
  theme(panel.grid.minor = element_blank()) + # 図の体裁
  labs(title = paste0(format(date_from, format = "%Y年%m月%d日"), "からの経過期間"), 
       fill = "日数の差", 
       x = "年-月", y = "日")
```

　基準の日にち(この例だと15日)における経過日数が全て0日で、月末にかけて1日ずつ増えるのを確認できる。月末の日数が異なるので、基準の日にちより前の日にちでは経過日数が異なる。\
\


### カレンダーで確認

　同様に、カレンダー形式で確認する。(色々あって同時期にカレンダーを作ったのでやってみるだけで、特に意味はない。たぶんこっちの方が分かりにくい。)詳しくは「ggplot2でカレンダーを作りたい」を参照のこと。\
\

<details><summary>・コード(クリックで展開)</summary>

　カレンダーの作図用のデータフレームを作成する。

```{r}
# カレンダー用に経過期間データを整形
calendar_df <- date_df |> 
  dplyr::select(date, day = date_day, d, ymd_label) |> 
  dplyr::bind_rows(
    tibble::tibble(
      # 1日間隔の日付を作成
      date = seq(
        from = (date_from - lubridate::days(1)) |> # (-1は基準日が月初の場合の簡易的対策)
          lubridate::floor_date(unit = "month"), # 基準日の月の初日
        to   = date_from - lubridate::days(1), # 基準日の前日
        by = "day"
      )
    )
  ) |> # 基準日の月のインデックスの計算用
  dplyr::arrange(date) |> # インデックスの計算用
  dplyr::mutate(
    year = date |> 
      lubridate::year() |> 
      as.numeric(), # 経過日の年
    month = date |> 
      lubridate::month() |> 
      as.numeric(), # 経過日の月
    dow_idx   = lubridate::wday(date), # 曜日番号(列インデックス)
    dow_label = lubridate::wday(date, label = TRUE) # 曜日ラベル
  ) |> 
  dplyr::group_by(year, month) |> # インデックスの作成用
  dplyr::mutate(
    cell_idx = dplyr::if_else(
      condition = date >= date_from, 
      true = dplyr::row_number() + head(dow_idx, n = 1) - 1, 
      false = NA_real_
    ), # セルインデックス
    week_idx = dplyr::if_else(
      condition = date >= date_from, 
      true = (cell_idx - 1) %/% 7 + 1, 
      false = NA_real_
    ) # 週番号(行インデックス)
  ) |> 
  dplyr::ungroup() |> 
  dplyr::filter(date >= date_from) # 基準日以前の日付を除去
calendar_df |> 
  dplyr::select(!day) # 資料用に間引き
```

　基準日以前の同月の日付を追加して、日付ごとに曜日番号と週番号(各日付が何曜日であるかと第何週であるか)を計算する。基準日以前の日付は、インデックスを欠損値にするかインデックスの計算後に取り除く。この例ではどちらも行っている。(基準日が月初だった場合は、前月の日付が追加されるが処理上の問題はない。)\

　基準日を表示するためのデータフレームを作成する。

```{r}
# 基準日を格納
date_from_df <- calendar_df |> 
  dplyr::filter(date == date_from) # 基準日のデータを抽出
date_from_df |> 
  dplyr::select(!day) # 資料用に間引き
```

　カレンダー用の値`calendar_df`から基準日`date_from`の値を取り出す。\

　カレンダー上にヒートマップとラベルを描画して確認する。

```{r, fig.width=15, fig.height=12, dpi=100}
# ラベル用の関数を作成
str_year <- function(string) {
  paste0(string, "年")
}
str_month <- function(string) {
  paste0(string, "月")
}

# 経過期間をカレンダー上のヒートマップで可視化
calendar_graph <- ggplot() + 
  geom_tile(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx, fill = d), 
            color = "black") + # 日付セル
  geom_tile(data = date_from_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            fill = "blue", color = "blue", alpha = 0.1) + # 基準日セル
  geom_label(data = calendar_df, 
             mapping = aes(x = dow_idx-0.5, y = week_idx-0.5, label = day), 
             hjust = 0, vjust = 1, label.padding = unit(0.1, units = "line"), 
             size = 1.5) + # 日付ラベル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = ymd_label), 
            size = 1.5) + # 経過日数ラベル
  scale_x_continuous(breaks = 1:7, labels = lubridate::wday(1:7, label = TRUE)) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  scale_fill_gradient(low = "white" , high = "#00A968") + # 経過日数のグラデーション:(正の値のみの場合)
  #scale_fill_gradient2(low = "hotpink", mid = "white" , high = "#00A968") + # 経過日数のグラデーション:(負の値を含む場合)
  facet_wrap(year ~ month, labeller = labeller(year = str_year, month = str_month)) + # 月ごとに分割
  theme(panel.grid.minor = element_blank()) + # 図の体裁
  labs(title = paste0(format(date_from, format = "%Y年%m月%d日"), "からの経過期間"), 
       fill = "経過日数", 
       x = "曜日", y = "週")
#calendar_graph
```

</details>

```{r, echo=FALSE, fig.width=15, fig.height=12, dpi=100}
### 資料作成用:(再掲)

calendar_graph
```

　`geom_tile()`と`geome_label()`でカレンダー形式でヒートマップを描画する。\
\


## 事前・事後の日ごとに経過日数

　ここまでは、指定した日以降の日付を扱った。最後は、指定した日以前の日付も含めて経過期間を求める。\
\


### 期間計算

　基準となる日と期間を設定して、日ごとに経過期間を計算する。

```{r}
# 基準日を指定
date_from <- "2022-01-30" |> 
  lubridate::as_date()

# 期間を指定
date_min <- "2020-12-10" |> 
  lubridate::as_date()
date_max <- "2022-03-10" |> 
  lubridate::as_date()

# 基準日以前・以降の日ごとに経過期間を計算
date_df <- tibble::tibble(
  # 1日間隔の日付を作成
  date = seq(from = date_min, to = date_max, by = "day")
) |> 
  dplyr::mutate(
    # 期間計算用の値を作成
    date_day = date |> 
      lubridate::day() |> 
      as.numeric(), # 経過日の日にち
    from_day = date_from |> 
      lubridate::day() |> 
      as.numeric(), # 基準日の日にち
    last_day = date |> 
      lubridate::rollforward() |> 
      lubridate::day() |> 
      as.numeric(),# 基準日の月の末日
    pre_last_day = date |> 
      lubridate::rollback() |> 
      lubridate::day() |> 
      as.numeric(), # 経過日の前月の末日
    next_last_day = date |> 
      lubridate::rollforward(roll_to_first = TRUE) |> 
      lubridate::rollforward() |> 
      lubridate::day() |> 
      as.numeric(), # 経過日の翌月の末日
    # 経過期間を計算
    y = dplyr::case_when(
      date >= date_from ~ lubridate::interval(start = date_from, end = date) |> 
        lubridate::time_length(unit = "year") |> 
        floor(), 
      date < date_from ~ lubridate::interval(start = date, end = date_from) |> 
        lubridate::time_length(unit = "year") |> 
        floor() * (-1), 
    ), # 経過年数
    m = dplyr::case_when(
      date >= date_from ~ lubridate::interval(start = date_from, end = date) |> 
        lubridate::time_length(unit = "month") |> 
        floor() %% 12, 
      date < date_from ~ lubridate::interval(start = date, end = date_from) |> 
        lubridate::time_length(unit = "month") |> 
        floor() %% 12 * (-1)
    ), # 経過月数
    d = dplyr::case_when(
      (date >= date_from & from_day >  date_day & from_day <  pre_last_day) ~ pre_last_day - from_day + date_day, # 前月の途中から当月の途中まで
      (date >= date_from & from_day >  date_day & from_day >= pre_last_day) ~ date_day, # 当月の頭から当月の途中まで
      (date >= date_from & from_day <= date_day) ~ date_day - from_day, # 当月の途中から当月の途中まで
      (date <  date_from & from_day <  date_day & from_day <= next_last_day) ~ date_day - last_day - from_day, # 当月の途中から翌月の途中まで
      (date <  date_from & from_day <  date_day & from_day >  next_last_day) ~ date_day - last_day - next_last_day-1, # 当月の途中から翌々月の頭まで
      (date <  date_from & from_day >= date_day & from_day <= last_day) ~ date_day - from_day, # 当月の途中から当月の途中まで
      (date <  date_from & from_day >= date_day & from_day >  last_day) ~ date_day - last_day-1 # 当月の途中から翌月の頭まで
    ), # 経過日数
    days = lubridate::interval(start = date_from, end = date) |> 
      lubridate::time_length(unit = "day"), # 総経過日数
    ymd_label = paste0(y, "年", m, "か月", d, "日") # 経過期間ラベル
  )
date_df |> 
  dplyr::select(!c(date_day, from_day)) # 資料用に間引き
```

　基準日`date_from`、期間の開始日`date_min`と最終日`date_max`を日付型の値で指定する。\
　「日ごとの経過日数」のときと同様に、`date_min`から`date_max`までの日付を作成して、経過日の日にち列`date_day`、基準日の日にち列`from_day`、経過日の月末の日にち列`last_day`、経過日の前月末の日にち列`pre_last_day`、経過日の翌月末の日にち列`next_last_day`を作成しておく。\

　「経過日」が「基準日」以降(`date`が`date_from`以上)の場合は、基準日`date_from`から各経過日`date`までの経過年数列`y`、経過月数列`m`を計算する。\
　「経過日」が「基準日」以前(`date`が`date_from`未満)の場合は、各経過日`date`から基準日`date_from`までの経過年数列`y`、経過月数列`m`を計算して、それぞれ負の値にする(`-1`を掛ける)。\

　経過日数列`d`は、「基準日」と「経過日」、また「基準日の日にち」と「経過日の日にち」または「経過日の前月末の日にち」との大小関係によって場合分けして計算する。

- 「経過日」が「基準日」以降(`date`が`date_from`以上)または同じ場合は、「日ごとの経過日数」のときと同様にして日数を求める。
    - 「経過日の日にち」から「基準の日にち」まで(`form_day`が`date_day`より大きい場合)の日数を、さらに2つの場合に応じて計算する。
        - 「基準の日にち」が「前月に有る」(`from_day`が`pre_last_day`より小さい)場合は、「前月の基準の日から月末までの日数」(`pre_last_day - from_day`)と「当月の経過日数」(`date_day`)の和である。
        - 「基準の日にち」が「前月に無い・前月末の日にち」(`from_day`が`pre_last_day`以上)の場合は、基準の日を月末とみなして、「当月の経過日数」(`date_day`)である。
    - 「基準の日にち」から「経過日の日にち」まで(`form_day`が`date_day`以下の場合)の日数は、「当月の基準の日から経過日までの日数」(`date_day - from_day`)である。
- 「経過日」が「基準日」以前(`date`が`date_from`未満)の場合は、負の日数を求める。
    - 「経過日の日にち」から「基準の日にち」まで(`form_day`が`date_day`より小さい場合)の負の日数は、「当月の経過日から月末までの負の日数」(`date_day - last_day - 1`)と「翌月の基準の日までの負の日数」(`1 - from_day`)の和である。
    - ただし「翌月に基準の日にちが無い」(`from_day`が`next_last_day`より大きい)場合は、基準の日を翌々月の初日とみなして、「翌月の初日から翌々月の初日までの負の日数」(`1 - (next_last_day+1)`)との和である。
    - 「基準の日にち」から「経過日の日にち」まで(`form_day`が`date_day`以上の場合)の負の日数は、「経過日から当月の基準の日までの負の日数」(`date_day - from_day`)である。
    - ただし「当月に基準の日にちが無い」(`from_day`が`last_day`より大きい)場合は、基準の日を翌月の初日とみなして、「経過日から翌月の初日までの負の日数」(`date_day - (last_day+1)`)である。

　経過日数列`y, m, d`を用いて、経過日数ラベルを作成して`ymd_label`列とする。\
\

　以上で、経過期間を計算できた。続いて、計算結果を確認する。\
\


### ヒートマップで確認

　ヒートマップとラベルで計算結果を確認する。\
\

　「ひと年のカレンダー」のときのコードで、作図用のデータフレームを作成して、ヒートマップとラベルで経過期間を確認する。

```{r, echo=FALSE}
### 資料作成用:(再掲)

# ヒートマップ用に経過期間データを整形
heatmap_df <- date_df |> 
  dplyr::select(date, d, days, ymd_label, day = date_day) |> 
  dplyr::mutate(
    year_month = date |> 
      format(format = "%Y-%m") |> 
      factor() # 年月ラベル
  )
```

```{r}
# 確認
heatmap_df
```

```{r, echo=FALSE, fig.width=20, fig.height=10, dpi=100}
### 資料作成用:(再掲)

# 経過期間をヒートマップで可視化
ggplot() + 
  geom_tile(data = heatmap_df, 
            mapping = aes(x = year_month, y = day, fill = d)) + # 日付セル
  geom_tile(mapping = aes(x = format(date_from, format = "%Y-%m"), y = lubridate::day(date_from)), 
            fill = "blue", color = "blue", alpha = 0.1) + # 基準日セル
  geom_text(data = heatmap_df, 
            mapping = aes(x = year_month, y = day, label = ymd_label)) + # 経過期間ラベル
  scale_y_reverse(breaks = 1:31) + # 日軸
  #scale_fill_gradient(low = "white" , high = "#00A968") + # 経過日数のグラデーション:(正の値のみの場合)
  scale_fill_gradient2(low = "hotpink", mid = "white" , high = "#00A968") + # 経過日数のグラデーション:(負の値を含む場合)
  theme(panel.grid.minor = element_blank()) + # 図の体裁
  labs(title = paste0(format(date_from, format = "%Y年%m月%d日"), "からの経過期間"), 
       fill = "日数の差", 
       x = "年-月", y = "日")
```

　基準日以前の日においても、基準の日にち(この例だと15日)における経過日数が全て0日なのを確認できる。月初にかけて1日ずつ減る。月末の日数が異なるので、基準の日にちより後の日にちでは経過日数が異なる。\
\


### カレンダーで確認

　一応こっちもやっておく。\
\

<details><summary>・コード(クリックで展開)</summary>

　カレンダーの作図用のデータフレームを作成する。

```{r}
# カレンダー用に経過期間データを整形
calendar_df <- date_df |> 
  dplyr::select(date, day = date_day, d, ymd_label) |> 
  dplyr::bind_rows(
    tibble::tibble(
      # 1日間隔の日付を作成
      date = seq(
        from = (date_min - lubridate::days(1)) |> # (-1は期間の開始日が月初の場合の簡易的対策)
          lubridate::floor_date(unit = "month"), # 期間の開始日の月の初日
        to   = date_min - lubridate::days(1), # 期間の開始の前日
        by = "day"
      )
    )
  ) |> # 基準日の月のインデックスの計算用
  dplyr::arrange(date) |> # インデックスの計算用
  dplyr::mutate(
    year = date |> 
      lubridate::year() |> 
      as.numeric(), # 経過日の年
    month = date |> 
      lubridate::month() |> 
      as.numeric(), # 経過日の月
    dow_idx   = lubridate::wday(date), # 曜日番号(列インデックス)
    dow_label = lubridate::wday(date, label = TRUE) # 曜日ラベル
  ) |> 
  dplyr::group_by(year, month) |> # インデックスの作成用
  dplyr::mutate(
    cell_idx = dplyr::if_else(
      condition = date >= date_min, 
      true = dplyr::row_number() + head(dow_idx, n = 1) - 1, 
      false = NA_real_
    ), # セルインデックス
    week_idx = dplyr::if_else(
      condition = date >= date_min, 
      true = (cell_idx - 1) %/% 7 + 1, 
      false = NA_real_
    ) # 週番号(行インデックス)
  ) |> 
  dplyr::ungroup() |> 
  dplyr::filter(date >= date_min) # 基準日以前の日付を除去
calendar_df |> 
  dplyr::select(!day) # 資料用に間引き
```

　基準日`date_from`ではなく期間の開始日`date_min`を用いて、「ひと年のカレンダー」のときと同様に処理する。\

　「ひと年のカレンダー」のときのコードで、カレンダー上にヒートマップとラベルを描画して確認する。

</details>

```{r, echo=FALSE, fig.width=15, fig.height=12, dpi=100}
### 資料作成用:(再掲)

# 基準日を格納
date_from_df <- calendar_df |> 
  dplyr::filter(date == date_from) # 基準日のデータを抽出

# 経過期間をカレンダー上のヒートマップで可視化
ggplot() + 
  geom_tile(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx, fill = d), 
            color = "black") + # 日付セル
  geom_tile(data = date_from_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            fill = "blue", color = "blue", alpha = 0.1) + # 基準日セル
  geom_label(data = calendar_df, 
             mapping = aes(x = dow_idx-0.5, y = week_idx-0.5, label = day), 
             hjust = 0, vjust = 1, label.padding = unit(0.1, units = "line"), 
             size = 1.5) + # 日付ラベル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = ymd_label), 
            size = 1.5) + # 経過日数ラベル
  scale_x_continuous(breaks = 1:7, labels = lubridate::wday(1:7, label = TRUE)) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  #scale_fill_gradient(low = "white" , high = "#00A968") + # 経過日数のグラデーション:(正の値のみの場合)
  scale_fill_gradient2(low = "hotpink", mid = "white" , high = "#00A968") + # 経過日数のグラデーション:(負の値を含む場合)
  facet_wrap(year ~ month, labeller = labeller(year = str_year, month = str_month)) + # 月ごとに分割
  theme(panel.grid.minor = element_blank()) + # 図の体裁
  labs(title = paste0(format(date_from, format = "%Y年%m月%d日"), "からの経過期間"), 
       fill = "経過日数", 
       x = "曜日", y = "週")
```

\ 

　この記事では、経過期間を計算した。\
\

