---
title: "カレンダーの作図"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  html_document:
    toc: TRUE       # 目次
    toc_depth: 3    # 目次の見出しレベル
    toc_float: TRUE # 目次のスクロール追跡
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# ggplot2でカレンダーを作成したい

　ggplot2パッケージを利用してカレンダーを作成する。\
\

　利用するパッケージを読み込む。

```{r, eval=FALSE}
# 利用パッケージ
library(tidyverse)
library(lubridate)
library(zipangu)
```

```{r, echo=FALSE}
### 資料作成用

# チェック用
library(ggplot2)
```

　この記事では基本的に、`パッケージ名::関数名()`の記法を使うので、パッケージを読み込む必要はない。ただし、作図コードについてはパッケージ名を省略するため、`ggplot2`を読み込む必要がある。\
　また、`magrittr`パッケージのパイプ演算子`%>%`ではなく、ネイティブパイプ演算子`|>`を使う。`%>%`に置き換えても処理できるが、その場合は`magrittr`を読み込む必要がある。\
\


## インデックスの確認

　まずは、カレンダーの作図に用いるインデックス(日ごとのプロット位置)を確認する。\
\

　行と列のインデックスを作成する。

```{r}
# インデックスを作成
index_df <- tibble::tibble(
  week_idx = rep(1:6, each = 7),  # 行インデックス
  dow_idx  = rep(1:7, times = 6), # 列インデックス
  cell_idx = 1:(7*6) # セルインデックス
)
index_df
```

　行インデックス(縦方向のプロット位置)として、第6週までを表す`1`から`6`の整数を作成して、`week_idx`列とする。\
　列インデックス(横方向のプロット位置)として、曜日を表す`1`から`7`の整数を作成して、`dow_idx`列とする。\
　セルインデックスとして、`1`から`7 * 6`の整数を作成して、`cell_idx`列とする。\

　インデックスを確認する。

```{r, fig.width=7, fig.height=6, dpi=100}
# インデックスを作図
ggplot() + 
  geom_tile(data = index_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            color = "black", alpha = 0) + # セル
  geom_text(data = index_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = cell_idx), 
            size = 10) + # セルインデックスラベル
  scale_x_continuous(breaks = 1:max(index_df[["dow_idx"]])) + # 行インデックス
  scale_y_reverse(breaks = 1:max(index_df[["week_idx"]])) + # 列インデックス
  coord_fixed(ratio = 1) + # アスペクト比
  theme(panel.grid.minor = element_blank()) + # 図の体裁
  labs(title = "セルインデックス (cell_idx)", 
       x = "曜日インデックス (dow_idx)", 
       y = "週インデックス (week_idx)")
```

　6×7個の日付セルでカレンダーを表現できる。各セルの交点は、曜日番号±0.5、週番号±0.5である。\
　交点を作らない場合は、`geom_tile()`の`width`引数で横サイズ、`height`引数で縦サイズを調整できる。\

　セルインデックスは、横縦の順に割り当てておき、行インデックス(第何週か)の計算に用いる。\
\


## ひと月のカレンダー

　1か月のカレンダーを作成する。\
\


### 基本形

　作成するカレンダーの年と月を指定して、日付データを作成する。

```{r}
# 年を指定
year <- 2024

# 月を指定
month <- 2

# ひと月の暦データを作成
date_df <- tibble::tibble(
  # 1日間隔の日付を作成
  date = seq(
    from = paste0(year, "-", month, "-01") |> 
      lubridate::as_date(), # 初日
    to   = paste0(year, "-", month, "-01") |> 
      lubridate::as_date() |> 
      lubridate::rollforward(), # 末日
    by = "day"
  ), 
) |> 
  dplyr::mutate(
    day = lubridate::day(date), # 日にちラベル
    # 作図用の値を作成
    dow_idx   = lubridate::wday(date), # 曜日番号(列インデックス)
    dow_label = lubridate::wday(date, label = TRUE), # 曜日ラベル
    cell_idx  = day + head(dow_idx, n = 1) - 1, # セルインデックス
    week_idx  = (cell_idx - 1) %/% 7 + 1 # 週番号(行インデックス)
  )
date_df
```

　年を`year`、月を`month`として整数を指定する。\

　指定した月の月初から月末までの日付を作成して、データフレームに格納する。月初の日付を表す文字列`yyyy-mm-01`を作成して、`as_date()`で日付型に変換して用いる。さらに、`rollforward()`で月末の日付が得られる。\
　日付ごとに、`day()`で日にち列、`wday()`で曜日番号列を作成する。また確認用に、`wday()`の`label`引数を`TRUE`にして、曜日ラベル列を作成する。\
　「月初の曜日番号-1」に各日付の「日にち」を加えるとセル番号が得られる。\
　「セル番号-1」を「7で割った余り」に「1」を加えると週番号が得られる。商余は`%/%`で計算できる。\

　1か月分のカレンダーの原型を作成する。

```{r, fig.width=7, fig.height=6, dpi=100}
# 横軸ラベルを作成
dow_label_vec <- lubridate::wday(1:7, label = TRUE) # 日本語名
#dow_label_vec <- lubridate::wday(1:7, label = TRUE, abbr = TRUE, locale = "en_US") # 英語名の省略形

# ひと月のカレンダーを作図:(原型)
ggplot() + 
  geom_tile(data = date_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            fill = "white", color = "black") + # 日付セル
  geom_text(data = date_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = day), 
            size = 10) + # 日付ラベル
  scale_x_continuous(breaks = 1:7, labels = dow_label_vec) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  coord_fixed(ratio = 1) + # アスペクト比
  theme(panel.grid.minor = element_blank()) + # 図の体裁
  labs(title = paste0(year, "年", month, "月のカレンダー"), 
       x = "曜日", y = "週")
```

　日ごとのセルを`geom_tile()`、日付ラベルなどを`geom_text()`で描画する。\
　`scale_x_continuous()`で横軸ラベルに曜日を表示して、`scale_y_reverse()`で縦軸を昇順にする。\

　月初の曜日が木曜日(曜日番号が5)の場合は、各日にちに4を足した値がセルインデックス(各セルインデックスを4移動すると日にち)に対応するのが分かる。\
\

　続いて、祝日とカレンダーの体裁を設定する。\
\


### 装飾

　祝日データを取得する。

```{r}
# 祝日情報を取得
holiday_vec <- zipangu::jholiday(year = year, lang = "jp") |> 
  unlist() |> 
  lubridate::as_date()
holiday_vec
```

　`zipangu`パッケージの`jholiday()`を使って日本の祝日情報を取得する。各祝日の日付がリストで出力されるので、`unlist()`でベクトルに変換する。その際に、日付がシリアル値になるので、`as_date()`で日付型に変換する。要素名が祝日名になる。要素名は`names()`で取り出せる。\

　祝日データを格納する。

```{r}
# 祝日の暦データを作成
tmp_holiday_df <- tibble::tibble(
  date = holiday_vec, # 祝日の日付
  holiday_label = names(holiday_vec), # 祝日ラベル
  dow_idx = lubridate::wday(date) # 振替休日の作成用
) |> 
  dplyr::filter(lubridate::month(date) == month) # 指定した月の祝日を抽出
tmp_holiday_df
```

　各祝日の日付と名前をデータフレームに格納して、指定した月のデータのみを取り出す。\
　振替休日の作成に用いる曜日番号も格納しておく。\

　祝日データに振替休日データを追加する。

```{r}
# 振替休日の暦データを作成
holiday_df <- tmp_holiday_df |> 
  dplyr::filter(dow_idx == 1) |> # 日曜日の祝日を抽出
  dplyr::mutate(
    date = dplyr::case_when(
      holiday_label == "憲法記念日" ~ date + lubridate::days(3), 
      holiday_label == "みどりの日" ~ date + lubridate::days(2), 
      TRUE ~ date + lubridate::days(1)
    ), # 日にち
    holiday_label = "振替休日", # 祝日名
    dow_idx = lubridate::wday(date) # 祝日データの結合用
  ) |> 
  dplyr::bind_rows(tmp_holiday_df) |> # 祝日の暦データを結合
  dplyr::select(date, holiday_label, holiday_label) |> # 日付データの結合用
  dplyr::arrange(date)
holiday_df
```

　祝日データから、祝日が日曜日の場合は取り出して、日付データを翌日の値に書き換える。ただし、憲法記念日とみどりの日の場合は、翌日も休日であるため、それぞれ3日後と2日後の値に書き換える。(翌月の日付になる場合は取り除く必要があるが、日本の場合は無いので省略。)\
　祝日データを`bind_rows()`で結合して、日付データと重複する(`date`列以外の)列を取り除く。\

　日付データに休日データを追加する。

```{r}
# 装飾用の暦データを作成
calendar_df <- date_df |> 
  dplyr::left_join(holiday_df, by = "date") |> # 祝日データを結合
  dplyr::mutate(
    day_type = dplyr::case_when(
      !is.na(holiday_label) ~ "holiday", 
      dow_label == "日" ~ "holiday", #(または) dow_idx == 7 ~ "holiday", 
      dow_label == "土" ~ "weekend", #(または) dow_idx == 1 ~ "weekend", 
      TRUE ~ "weekday"
    ) # 日付カテゴリ
  )
calendar_df
```

　日付データに祝日データを`left_join()`で結合する。\
　作図時の色付け用に、日付カテゴリを設定する。この例では、平日・日曜日と祝日・(祝日以外の)土曜日の3つに分類する。\

　セルを塗りつぶして休日を示すカレンダーを作成する。

```{r, fig.width=14, fig.height=12, dpi=100}
# ひと月のカレンダーを作図:(休日のセル色を変更)
calendar_fill <- ggplot() + 
  # geom_tile(data = calendar_df,
  #           mapping = aes(x = dow_idx, y = week_idx),
  #           fill = "white", color = "black") + # 平日セル
  geom_tile(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx, fill = day_type), 
            color = "black", alpha = 0.1) + # 休日セル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx-0.4, y = week_idx-0.4, label = day), 
            size = 10, hjust = 0, vjust = 1) + # 日付ラベル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx+0.45, y = week_idx-0.4, label = holiday_label), 
            size = 5, hjust = 1, vjust = 1, na.rm = TRUE) + # 祝日ラベル
  scale_x_continuous(breaks = 1:7, labels = NULL, 
                     sec.axis = dup_axis(trans = ~., labels = dow_label_vec)) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  scale_fill_manual(breaks = c("weekday", "holiday", "weekend"), 
                    values = c("white", "red", "blue")) + # 休日用の塗りつぶし色
  coord_fixed(ratio = 1, expand = FALSE) + # 描画領域
  theme(
    axis.title = element_blank(), # 軸ラベル
    axis.text.x = element_text(size = 30), # 横軸目盛ラベル
    axis.text.y = element_blank(), # 縦軸目盛ラベル
    axis.ticks = element_blank(), # 軸目盛指示線
    panel.grid.major = element_blank(), # 主グリッド線
    panel.grid.minor = element_blank(), # 副グリッド線
    panel.border = element_rect(fill = NA), # グラフ領域の枠線
    panel.background = element_blank(), # グラフ領域の背景
    plot.title = element_text(size = 25, face = "bold"), # タイトル
    plot.subtitle = element_text(size = 50, face = "bold", hjust = 0.5), # サブタイトル
    legend.position = "none" # 凡例の位置
  ) + # 図の体裁
  labs(title = paste0(year, "年"), 
       subtitle = paste0(month, "月"), 
       x = "曜日", y = "週")
calendar_fill
```

　`geom_tile()`の`fill`引数で、日付カテゴリごとにセルの色を塗りつぶして色分けする。カテゴリごとの色は`scale_fill_manual()`で設定できる。\
　`theme()`の`panel.background`引数で背景色を白にしない場合は、別の`geom_tile()`を使って全ての日付のセルを白にしておく必要がある。\

　日付の文字色を変更して休日を示すカレンダーを作成する。

```{r, fig.width=14, fig.height=12, dpi=100}
# ひと月のカレンダーを作図:(休日のラベル色を変更)
calendar_color <- ggplot() + 
  geom_tile(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            fill = "white", color = "black") + # 日付セル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx-0.4, y = week_idx-0.4, label = day, color = day_type), 
            size = 10, hjust = 0, vjust = 1) + # 日付ラベル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx+0.45, y = week_idx-0.4, label = holiday_label), 
            size = 5, color = "red", hjust = 1, vjust = 1, na.rm = TRUE) + # 祝日ラベル
  scale_x_continuous(breaks = 1:7, labels = NULL, 
                     sec.axis = dup_axis(trans = ~., labels = dow_label_vec)) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  scale_color_manual(breaks = c("weekday", "holiday", "weekend"), 
                     values = c("black", "red", "blue")) + # 休日用文字色
  coord_fixed(ratio = 1, expand = FALSE) + # 描画領域
  theme(
    axis.title = element_blank(), # 軸ラベル
    axis.text.x = element_text(size = 30), # 横軸目盛ラベル
    axis.text.y = element_blank(), # 縦軸目盛ラベル
    axis.ticks = element_blank(), # 軸目盛指示線
    panel.grid.major = element_blank(), # 主グリッド線
    panel.grid.minor = element_blank(), # 副グリッド線
    panel.border = element_rect(fill = NA), # グラフ領域の枠線
    #panel.background = element_blank(), # グラフ領域の背景
    plot.title = element_text(size = 25, face = "bold"), # タイトル
    plot.subtitle = element_text(size = 50, face = "bold", hjust = 0.5), # サブタイトル
    legend.position = "none" # 凡例の位置
  ) + # 図の体裁
  labs(title = paste0(year, "年"), 
       subtitle = paste0(month, "月"), 
       x = "曜日", y = "週")
calendar_color
```

　`geom_text()`の`color`引数で、日付カテゴリごとに日にちラベルの文字色を変更して色分けする。カテゴリごとの色は`scale_txet_manual()`で設定できる。\
\

　以上で、カレンダーを作成できた。次は利用例として、予定を表示する。\
\


### 利用例

　スケジュールを指定する。

```{r}
# 予定日の暦データを作成
schedule_df <- tibble::tibble(
  date = c("2", "19", "22") |> # 日にちを指定
    (\(.){paste0(year, "-", month, "-", .)})() |> # 日付を作成
    lubridate::as_date(), 
  symbol = c("⚾", "🍈", "🎷") # 予定ラベルを指定
) |> 
  dplyr::left_join(
    calendar_df |> 
      dplyr::select(date, dow_idx, week_idx), 
    by = "date"
  ) # 作図用の値を結合
schedule_df
```

　日付と文字列をデータフレームに格納する。\
　`calendar_df`の曜日番号と週番号を`left_join()`で日付に応じて割り当てる。\

　スケジュールを表示したカレンダーを作成する。

```{r, fig.width=14, fig.height=12, dpi=100}
# スケジュールを重ねたカレンダーを作成
calendar_fill + 
  geom_text(data = schedule_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = symbol), 
            size = 15) # 予定ラベル
```

　作成したグラフ上に`geom_text()`で予定ラベルを描画する。\
\


## ひと年のカレンダー

　次は、1年のカレンダーを作成する。\
\


### 基本形

　作成するカレンダーの年を指定して、日付データを作成する。

```{r}
# 年を指定
year <- 2023

# ひと年の暦データを作成
date_df <- tibble::tibble(
  # 1日間隔の日付を作成
  date = seq(
    from = paste0(year, "-1-1") |> 
      lubridate::as_date(), # 正月
    to   = paste0(year, "-12-31") |> 
      lubridate::as_date(), # 大晦日
    by = "day"
  )
) |> 
  dplyr::mutate(
    year  = lubridate::year(date),  # 年ラベル
    month = lubridate::month(date), # 月ラベル
    day   = lubridate::day(date),   # 日ラベル
    # 作図用の値を作成
    dow_idx   = lubridate::wday(date), # 曜日番号(列インデックス)
    dow_label = lubridate::wday(date, label = TRUE) # 曜日ラベル
  ) |> 
  dplyr::group_by(year, month) |> # インデックスの作成用
  dplyr::mutate(
    cell_idx = day + head(dow_idx, n = 1) - 1, # セルインデックス
    week_idx = (cell_idx - 1) %/% 7 + 1 # 週番号(行インデックス)
  ) |> 
  dplyr::ungroup()
date_df
```

　年を`year`として整数を指定する。\

　指定した年の正月から大晦日までの日付を作成して、データフレームに格納する。\
　日付ごとに、`year()`で年列、`month()`で月列、`day()`で日にち列を作成する\
　「ひと月のカレンダー」のときと同様に、曜日番号と週番号を作成する。ただし、週番号列は、年列と月列でグループ化して、月ごとに作成する。\

　1年分(12か月分)のカレンダーの原型を作成する。

```{r, fig.width=12, fig.height=9, dpi=100}
# 横軸ラベルを作成
dow_label_vec <- lubridate::wday(1:7, label = TRUE) # 日本語名
#dow_label_vec <- lubridate::wday(1:7, label = TRUE, abbr = TRUE, locale = "en_US") # 英語名の省略形

# ひと年のカレンダーを作図:(原型)
ggplot() + 
  geom_tile(data = date_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            fill = "white", color = "black") + # 日付セル
  geom_text(data = date_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = day), 
            size = 5) + # 日付ラベル
  scale_x_continuous(breaks = 1:7, labels = dow_label_vec) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  facet_wrap(month ~ ., labeller = "label_both") + # 月ごとに分割
  coord_fixed(ratio = 1) + # アスペクト比
  theme(panel.grid.minor = element_blank()) + # 図の体裁
  labs(title = paste0(year, "年のカレンダー"), 
       x = "曜日", y = "週")
```

　`facet_wrap()`に`month`列を指定して、月ごとに分割して描画する。\
\

　続いて、祝日とカレンダーの体裁を設定する。\
\


### 装飾

　祝日データを作成する。

```{r}
# 祝日情報を取得
holiday_vec <- zipangu::jholiday(year = year, lang = "jp") |> 
  unlist() |> 
  lubridate::as_date()

# 祝日の暦データを作成
tmp_holiday_df <- tibble::tibble(
  date = holiday_vec, # 祝日の日付
  holiday_label = names(holiday_vec), # 祝日ラベル
  dow_idx = lubridate::wday(date) # 振替休日の作成用
)

# 祝日ラベルの文字数を指定
threshold <- 5

# 振替休日の暦データを作成
holiday_df <- tmp_holiday_df |> 
  dplyr::filter(dow_idx == 1) |> # 日曜日の祝日を抽出
  dplyr::mutate(
    date = dplyr::case_when(
      holiday_label == "憲法記念日" ~ date + lubridate::days(3), 
      holiday_label == "みどりの日" ~ date + lubridate::days(2), 
      TRUE ~ date + lubridate::days(1)
    ), # 日にち
    holiday_label = "振替休日", # 祝日名
    dow_idx = lubridate::wday(date) # 祝日データの結合用
  ) |> 
  dplyr::bind_rows(tmp_holiday_df) |> # 祝日の暦データを結合
  dplyr::mutate(
    label_size = dplyr::if_else(
      condition = nchar(holiday_label) <= threshold, 
      true  = "normal", 
      false = "small"
    ) # ラベルサイズカテゴリ:(日付ラベルと祝日ラベルが重なる対策)
  ) |> 
  dplyr::select(date, holiday_label, label_size) |> # 日付データの結合用
  dplyr::arrange(date)
holiday_df
```

　「ひと月のカレンダー」のときと同様にして、祝日の日付と名前をデータフレームに格納する。また、振替休日のデータフレームを作成する。\

　グラフサイズなどによっては、祝日名が日付ラベルに重なって表示されることがある。\
　そこでこの例では、文字数の閾値を`threshold`として、祝日名の文字数によってラベルサイズカテゴリを設定する。\

　日付データに休日データを追加する。

```{r}
# 装飾用の暦データを作成
calendar_df <- date_df |> 
  dplyr::left_join(holiday_df, by = "date") |> # 祝日データを結合
  dplyr::mutate(
    day_type = dplyr::case_when(
      !is.na(holiday_label) ~ "holiday", 
      dow_label == "日" ~ "holiday", #(または) dow_idx == 7 ~ "holiday", 
      dow_label == "土" ~ "weekend", #(または) dow_idx == 1 ~ "weekend", 
      TRUE ~ "weekday"
    ) # 日付カテゴリ
  )
calendar_df
```

　「ひと月のカレンダー」のときのコードで処理する。\

　ファセットラベルの設定用の関数を作成する。

```{r}
# ラベル用の関数を作成
str_month <- function(string) {
  paste0(string, "月") # 月の日本語名を出力
  # paste0("2000-", string, "-1") |> # 指定した月の適当な日付を作成
  #   as.Date() |> # 日付型に変換
  #   lubridate::month(label = TRUE, abbr = FALSE, locale = "en_US") |>  # 月の英語名に変換
  #   as.character() # 文字列型に変換して出力
}
str_month(month)
```

　月を示す整数の文字列を受け取り、`n月`の形(または英語名)にして返す関数を定義する。\
　月名列を作成しておき、その列をグラフの分割に使ってもよい。\

　セルを塗りつぶして休日を示すカレンダーを作成する。

```{r, fig.width=40, fig.height=30, dpi=100}
# ひと年のカレンダーを作図:(休日のセル色を変更)
calendar_fill <- ggplot() + 
  # geom_tile(data = calendar_df, 
  #           mapping = aes(x = dow_idx, y = week_idx), 
  #           fill = "white", color = "black") + # 平日セル
  geom_tile(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx, fill = day_type), 
            color = "black", alpha = 0.1) + # 休日セル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx-0.4, y = week_idx-0.4, label = day), 
            size = 10, hjust = 0, vjust = 1) + # 日付ラベル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx+0.45, y = week_idx-0.4, label = holiday_label, size = label_size), 
            hjust = 1, vjust = 1, na.rm = TRUE) + # 祝日ラベル
  scale_x_continuous(breaks = 1:7, labels = NULL, 
                     sec.axis = dup_axis(trans = ~., labels = dow_label_vec)) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  scale_fill_manual(breaks = c("weekday", "holiday", "weekend"), 
                    values = c("white", "red", "blue")) + # 休日用塗りつぶし色
  scale_size_manual(breaks = c("normal", "small"), 
                    values = c(4, 3)) + # (日付ラベルと祝日ラベルが重なる対策)
  facet_wrap(month ~ ., nrow = 3, ncol = 4, 
             labeller = labeller(month = str_month), scales = "free_x") + # 年・月ごとに分割
  coord_cartesian(expand = FALSE) + # 描画領域
  theme(
    axis.title = element_blank(), # 軸ラベル
    axis.text.x = element_text(size = 30), # 横軸目盛ラベル
    axis.text.y = element_blank(), # 縦軸目盛ラベル
    axis.ticks = element_blank(), # 軸目盛指示線
    panel.grid.major = element_blank(), # 主グリッド線
    panel.grid.minor = element_blank(), # 副グリッド線
    panel.border = element_rect(fill = NA), # グラフ領域の枠線
    panel.background = element_blank(), # グラフ領域の背景
    plot.title = element_text(size = 50, face = "bold", hjust = 0.5), # タイトル
    strip.text = element_text(size = 50, face = "bold"), # ファセットラベルの文字
    strip.background = element_blank(), # ファセットラベル領域の背景
    strip.placement = "outside", # ファセットラベルの位置
    legend.position = "none" # 凡例の位置
  ) + # 図の体裁
  labs(title = paste0(year, "年"), 
       x = "曜日", y = "週")
calendar_fill
```

　`facet_wrap()`の`labeller`引数に`labeller()`を使ってファセットラベルを設定できる。\

　日付の文字色を変更して休日を示すカレンダーを作成する。

```{r, fig.width=40, fig.height=30, dpi=100}
# ひと年のカレンダーを作図:(休日のラベル色を変更)
calendar_color <- ggplot() + 
  geom_tile(data = calendar_df, 
            mapping = aes(x = dow_idx, y = week_idx), 
            fill = "white", color = "black") + # 日付セル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx-0.4, y = week_idx-0.4, label = day, color = day_type), 
            size = 10, hjust = 0, vjust = 1) + # 日付ラベル
  geom_text(data = calendar_df, 
            mapping = aes(x = dow_idx+0.45, y = week_idx-0.4, label = holiday_label), 
            size = 4, color = "red", hjust = 1, vjust = 1, na.rm = TRUE) + # 祝日ラベル
  scale_x_continuous(breaks = 1:7, labels = NULL, 
                     sec.axis = dup_axis(trans = ~., labels = dow_label_vec)) + # 曜日軸
  scale_y_reverse(breaks = 1:6) + # 週軸
  scale_color_manual(breaks = c("weekday", "holiday", "weekend"), 
                     values = c("black", "red", "blue")) + # 休日用文字色
  scale_size_manual(breaks = c("normal", "small"), 
                    values = c(4, 3)) + # (日付ラベルと祝日ラベルが重なる対策)
  facet_wrap(month ~ ., nrow = 3, ncol = 4, 
             labeller = labeller(month = str_month), scales = "free_x") + # 年・月ごとに分割
  coord_cartesian(expand = FALSE) + # 描画領域
  theme(
    axis.title = element_blank(), # 軸ラベル
    axis.text.x = element_text(size = 30), # 横軸目盛ラベル
    axis.text.y = element_blank(), # 縦軸目盛ラベル
    axis.ticks = element_blank(), # 軸目盛指示線
    panel.grid.major = element_blank(), # 主グリッド線
    panel.grid.minor = element_blank(), # 副グリッド線
    panel.border = element_rect(fill = NA), # グラフ領域の枠線
    #panel.background = element_blank(), # グラフ領域の背景
    plot.title = element_text(size = 50, face = "bold", hjust = 0.5), # タイトル
    strip.text = element_text(size = 50, face = "bold"), # ファセットラベルの文字
    strip.background = element_blank(), # ファセットラベル領域の背景
    strip.placement = "outside", # ファセットラベルの位置
    legend.position = "none" # 凡例の位置
  ) + # 図の体裁
  labs(title = paste0(year, "年"), 
       x = "曜日", y = "週")
calendar_color
```

　これまでと同様にして作図する。\
\

　以上で、カレンダーを作成できた。次は、利用例として予定を表示する。\
\


### 利用例

　スケジュールデータを作成する。

<details><summary>・コード(クリックで展開)</summary>

　ハロプロデータを読み込む。

```{r}
# フォルダパスを指定
dir_path <- "../../Hello/ChartRace/data/HP_DB-main/"

# 加入・卒業日一覧を読み込み
join_df <- readr::read_csv(
  file = paste0(dir_path, "join.csv"), 
  col_types = readr::cols(
    memberID = "i", 
    groupID = "i", 
    joinDate = readr::col_date(format = "%Y/%m/%d"), 
    gradDate = readr::col_date(format = "%Y/%m/%d")
  )
) |> 
  dplyr::arrange(joinDate, memberID, groupID) # 昇順に並び替え


# メンバー一覧を読み込み
member_df <- readr::read_csv(
  file = paste0(dir_path, "member.csv"), 
  col_types = readr::cols(
    memberID = "i", 
    memberName = "c", 
    HPjoinDate = readr::col_date(format = "%Y/%m/%d"), 
    debutDate = readr::col_date(format = "%Y/%m/%d"), 
    HPgradDate = readr::col_date(format = "%Y/%m/%d"), 
    memberKana = "c", 
    birthDate = readr::col_date(format = "%Y/%m/%d")
  )
) |> 
  dplyr::arrange(memberID) # 昇順に並べ替え
join_df; member_df
```

　グループ加入情報を`join_df`、メンバー情報を`member_df`としてそれぞれ読み込む。詳しくは「ハロプロチャートレース」を参照のこと。\

　誕生日データを作成する。

```{r}
# グループを指定
group_id <- 1

# 予定の暦データを作成
schedule_df <- join_df |> 
  dplyr::filter(groupID == group_id) |> # 指定グループの加入情報を抽出
  dplyr::left_join(
    member_df |> 
      dplyr::select(memberID, memberName, birthDate) |> 
      dplyr::distinct(), # 重複を削除
    by = "memberID"
  ) |> # 誕生日情報を結合
  dplyr::mutate(
    month = lubridate::month(birthDate), 
    day   = lubridate::day(birthDate), 
    date  = paste0(year, "-", as.character(month), "-", as.character(day)) |> 
      lubridate::as_date(), 
    symbol = "🎂" # 記号を指定
  ) |> 
  dplyr::select(date, symbol, memberName, month) |> 
  dplyr::left_join(
    calendar_df |> 
      dplyr::select(date, dow_idx, week_idx), 
    by = "date"
  ) |> # 作図用の値を結合
  dplyr::arrange(date)
schedule_df
```

　グループIDを指定して、`join_df`から所属メンバーのIDを抽出する。メンバーIDに応じて、`member_df`から誕生日情報を結合する。\
　各誕生日に応じて、`calendar_df`から曜日番号と週番号を結合する。\

</details>

　スケジュールを表示したカレンダーを作成する。

```{r, fig.width=40, fig.height=30, dpi=100}
# スケジュールを重ねたカレンダーを作成
calendar_fill + 
  geom_text(data = schedule_df, 
            mapping = aes(x = dow_idx, y = week_idx, label = symbol), 
            size = 15) + # 予定マーク
  geom_text(data = schedule_df, 
            mapping = aes(x = dow_idx, y = week_idx+0.45, label = memberName), 
            size = 5, vjust = 0) # 予定ラベル
```

　作成したグラフ上に予定を表すマークとラベルを描画する。\
\


